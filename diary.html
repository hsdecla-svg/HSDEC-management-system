<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HSDEC | Activity Diary Pro</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background: #f8fafc; }
        .form-input, .form-select, .form-textarea { border: 2px solid #e2e8f0; padding: 12px; border-radius: 12px; width: 100%; font-weight: 700; outline: none; }
        .label-cap { font-size: 10px; font-weight: 900; color: #94a3b8; text-transform: uppercase; margin-bottom: 4px; display: block; }
        
        .color-Chanthaviphone { border-left: 8px solid #3b82f6; }
        .color-Sengmala { border-left: 8px solid #ec4899; }
        .color-Takashi { border-left: 8px solid #f59e0b; }
        .color-Chansouk { border-left: 8px solid #10b981; }
        .color-Mim { border-left: 8px solid #8b5cf6; }
        .color-Other { border-left: 8px solid #64748b; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .snap-x { scroll-snap-type: x mandatory; }
        .snap-center { scroll-snap-align: center; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const SUPABASE_URL = 'https://zgmqllufmqanixgwdjok.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_vOgl-K0RTxyK9i0WJp7UwA_PlwVgESz';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const STAFF_LIST = ["Mr. Chanthaviphone", "Ms. Sengmala", "Mr. Takashi", "Ms. Chansouk", "Ms. Mim", "Other"];
        const CATEGORIES = ["Labor Inspection (労働者様子)", "Meeting (会議)", "Field Visit (視察)", "Training (研修)", "Other"];

        function DiaryApp() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('list'); // 'list', 'detail', 'edit'
            const [entries, setEntries] = useState([]);
            const [dForm, setDForm] = useState({ photos: [], labor_stats: "0,0,0" });
            const [searchTerm, setSearchTerm] = useState('');
            const [filterCategory, setFilterCategory] = useState('All');

            useEffect(() => {
                const savedUser = localStorage.getItem('hsdec_user');
                if (savedUser) setUser(JSON.parse(savedUser));
                else window.location.href = 'index.html';
                fetchEntries();
            }, []);

            const fetchEntries = async () => {
                const { data } = await supabase.from('diary').select('*').order('date', { ascending: false }).order('created_at', { ascending: false });
                if (data) {
                    const formatted = data.map(item => ({
                        ...item,
                        photos: item.photo_url ? JSON.parse(item.photo_url) : []
                    }));
                    setEntries(formatted);
                }
            };

            const handlePhotoUpload = (e) => {
                const files = Array.from(e.target.files);
                const currentPhotos = dForm.photos || [];
                if (currentPhotos.length + files.length > 5) { alert("Max 5 photos allowed"); return; }
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX_WIDTH = 800;
                            let width = img.width, height = img.height;
                            if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                            canvas.width = width; canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            const compressed = canvas.toDataURL('image/jpeg', 0.6);
                            setDForm(prev => ({ ...prev, photos: [...prev.photos, compressed] }));
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            };

            const handleSave = async (e) => {
                e.preventDefault();
                const payload = {
                    date: dForm.date || new Date().toISOString().split('T')[0],
                    staff_name: dForm.staff_name || STAFF_LIST[0],
                    category: dForm.category || CATEGORIES[0],
                    content: dForm.content || "",
                    labor_stats: dForm.labor_stats || "0,0,0",
                    photo_url: JSON.stringify(dForm.photos || []),
                    recorded_by: user.name
                };
                if (dForm.id) payload.id = dForm.id;
                const { error } = await supabase.from('diary').upsert([payload]);
                if (!error) { setView('list'); fetchEntries(); }
            };

            const handleDelete = async (id) => {
                if(confirm("Are you sure you want to delete this log?")) {
                    const { error } = await supabase.from('diary').delete().eq('id', id);
                    if (!error) { setView('list'); fetchEntries(); }
                }
            };

            const filteredEntries = entries.filter(item => {
                const matchesSearch = (item.content + item.staff_name).toLowerCase().includes(searchTerm.toLowerCase());
                const matchesCat = filterCategory === 'All' || item.category === filterCategory;
                return matchesSearch && matchesCat;
            });

            const getColorClass = (name) => {
                const n = name.replace("Mr. ", "").replace("Ms. ", "");
                return `color-${n}`;
            };

            if (!user) return null;

            return (
                <div className="max-w-2xl mx-auto p-4 pb-20">
                    {/* --- LIST VIEW --- */}
                    {view === 'list' && (
                        <>
                            <header className="flex justify-between items-center py-6">
                                <h1 className="text-3xl font-black italic tracking-tighter uppercase leading-none">Activity Log</h1>
                                <button onClick={() => { setDForm({date: new Date().toISOString().split('T')[0], staff_name: user.name, category: CATEGORIES[0], photos: [], labor_stats: "0,0,0"}); setView('edit'); }} 
                                        className="bg-blue-600 text-white px-5 py-3 rounded-2xl font-black text-xs shadow-lg uppercase">+ New Log</button>
                            </header>

                            <div className="space-y-2 mb-6">
                                <input type="text" className="form-input shadow-sm border-none bg-white py-4" placeholder="Search entries..." 
                                       value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                                <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                                    {["All", ...CATEGORIES].map(cat => (
                                        <button key={cat} onClick={() => setFilterCategory(cat)} 
                                                className={`flex-shrink-0 px-4 py-2 rounded-full text-[10px] font-black uppercase transition-all ${filterCategory === cat ? 'bg-slate-800 text-white shadow-md' : 'bg-white text-slate-400 border border-slate-200'}`}>
                                            {cat}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <div className="space-y-4">
                                {filteredEntries.map(item => (
                                    <div key={item.id} onClick={() => { setDForm(item); setView('detail'); }} 
                                         className={`bg-white p-5 rounded-3xl shadow-sm border border-slate-100 ${getColorClass(item.staff_name)} cursor-pointer`}>
                                        <p className="text-[10px] font-black text-slate-400 uppercase">{item.date} • {item.category}</p>
                                        <h3 className="font-black text-slate-800 leading-none mt-1">{item.staff_name}</h3>
                                        <div className="flex gap-2 overflow-x-auto no-scrollbar my-3">
                                            {item.photos && item.photos.map((p, i) => (
                                                <img key={i} src={p} className="w-16 h-16 object-cover rounded-lg border flex-shrink-0 opacity-80" />
                                            ))}
                                        </div>
                                        <p className="text-slate-600 text-sm font-medium whitespace-pre-wrap line-clamp-2">{item.content}</p>
                                    </div>
                                ))}
                            </div>
                        </>
                    )}

                    {/* --- DETAIL VIEW --- */}
                    {view === 'detail' && (
                        <div className="bg-white rounded-[2.5rem] shadow-xl border overflow-hidden">
                            {/* Photo Slider */}
                            {dForm.photos && dForm.photos.length > 0 ? (
                                <div className="relative w-full aspect-square bg-slate-900 flex overflow-x-auto snap-x no-scrollbar">
                                    {dForm.photos.map((p, i) => (
                                        <img key={i} src={p} className="w-full h-full object-contain flex-shrink-0 snap-center" />
                                    ))}
                                    {dForm.photos.length > 1 && (
                                        <div className="absolute bottom-4 left-1/2 -translate-x-1/2 bg-black/30 px-3 py-1 rounded-full text-[10px] text-white font-bold">Swipe to see more →</div>
                                    )}
                                </div>
                            ) : (
                                <div className="w-full h-32 bg-slate-50 flex items-center justify-center text-slate-300 italic">No photos</div>
                            )}

                            <div className="p-8">
                                <div className="flex justify-between items-start mb-6">
                                    <div>
                                        <p className="text-xs font-black text-blue-500 uppercase">{dForm.date} • {dForm.category}</p>
                                        <h2 className="text-2xl font-black text-slate-900">{dForm.staff_name}</h2>
                                    </div>
                                    <button onClick={() => setView('list')} className="bg-slate-100 p-3 rounded-full">✕</button>
                                </div>

                                {dForm.category.includes("Labor") && (
                                    <div className="bg-blue-50 p-4 rounded-2xl flex gap-6 text-center mb-6 border border-blue-100">
                                        <div className="flex-1">
                                            <p className="text-[10px] font-black text-blue-400">PRESENT</p>
                                            <p className="text-xl font-black text-blue-700">{dForm.labor_stats.split(',')[0]}</p>
                                        </div>
                                        <div className="flex-1 border-x border-blue-200">
                                            <p className="text-[10px] font-black text-rose-400">ABSENT</p>
                                            <p className="text-xl font-black text-rose-600">{dForm.labor_stats.split(',')[1]}</p>
                                        </div>
                                        <div className="flex-1">
                                            <p className="text-[10px] font-black text-amber-500">LATE</p>
                                            <p className="text-xl font-black text-amber-600">{dForm.labor_stats.split(',')[2]}</p>
                                        </div>
                                    </div>
                                )}

                                <div className="prose prose-slate mb-8">
                                    <p className="text-slate-700 leading-relaxed font-medium whitespace-pre-wrap text-lg">
                                        {dForm.content}
                                    </p>
                                </div>

                                {/* 権限チェック: ログインユーザーと記録者が一致する場合のみ表示 */}
                                {user.name === dForm.staff_name && (
                                    <div className="grid grid-cols-2 gap-3 pt-6 border-t border-slate-100">
                                        <button onClick={() => setView('edit')} 
                                                className="bg-slate-900 text-white py-4 rounded-2xl font-black uppercase text-xs shadow-lg italic">Edit Log</button>
                                        <button onClick={() => handleDelete(dForm.id)} 
                                                className="bg-rose-50 text-rose-500 py-4 rounded-2xl font-black uppercase text-xs border border-rose-100">Delete</button>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* --- EDIT VIEW --- */}
                    {view === 'edit' && (
                        <div className="bg-white p-6 rounded-[2.5rem] shadow-xl border">
                            <form onSubmit={handleSave} className="space-y-4">
                                <div className="flex justify-between items-center mb-2">
                                    <button type="button" onClick={() => setView(dForm.id ? 'detail' : 'list')} className="text-slate-400 font-black text-xs uppercase">← Cancel</button>
                                    <span className="font-black italic text-xs text-blue-600 uppercase">{dForm.id ? 'Edit Entry' : 'New Entry'}</span>
                                </div>

                                <div className="grid grid-cols-2 gap-3">
                                    <div><label className="label-cap">Date</label><input type="date" className="form-input" value={dForm.date} onChange={e => setDForm({...dForm, date: e.target.value})} /></div>
                                    <div><label className="label-cap">Author</label>
                                        <select className="form-select bg-slate-50" value={dForm.staff_name} disabled={dForm.id}>
                                            {STAFF_LIST.map(s => <option key={s} value={s}>{s}</option>)}
                                        </select>
                                    </div>
                                </div>

                                <div><label className="label-cap">Category</label>
                                    <select className="form-select" value={dForm.category} onChange={e => setDForm({...dForm, category: e.target.value})}>
                                        {CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}
                                    </select>
                                </div>

                                {dForm.category.includes("Labor") && (
                                    <div className="bg-blue-50 p-4 rounded-2xl grid grid-cols-3 gap-3 border border-blue-200">
                                        <div><label className="label-cap text-blue-600 text-center">Present</label>
                                            <input type="number" className="form-input text-center" value={dForm.labor_stats.split(',')[0]} onChange={e => {
                                                const s = dForm.labor_stats.split(','); s[0] = e.target.value; setDForm({...dForm, labor_stats: s.join(',')});
                                            }} />
                                        </div>
                                        <div><label className="label-cap text-rose-500 text-center">Absent</label>
                                            <input type="number" className="form-input text-center" value={dForm.labor_stats.split(',')[1]} onChange={e => {
                                                const s = dForm.labor_stats.split(','); s[1] = e.target.value; setDForm({...dForm, labor_stats: s.join(',')});
                                            }} />
                                        </div>
                                        <div><label className="label-cap text-amber-500 text-center">Late</label>
                                            <input type="number" className="form-input text-center" value={dForm.labor_stats.split(',')[2]} onChange={e => {
                                                const s = dForm.labor_stats.split(','); s[2] = e.target.value; setDForm({...dForm, labor_stats: s.join(',')});
                                            }} />
                                        </div>
                                    </div>
                                )}

                                <div>
                                    <label className="label-cap text-slate-400">Photos (Max 5)</label>
                                    <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                                        {dForm.photos && dForm.photos.map((p, i) => (
                                            <div key={i} className="relative flex-shrink-0">
                                                <img src={p} className="w-24 h-24 object-cover rounded-xl border shadow-sm" />
                                                <button type="button" onClick={() => {
                                                    const updated = [...dForm.photos]; updated.splice(i, 1);
                                                    setDForm({...dForm, photos: updated});
                                                }} className="absolute -top-1 -right-1 bg-rose-500 text-white w-5 h-5 rounded-full text-[10px] font-black shadow-lg">✕</button>
                                            </div>
                                        ))}
                                        {(!dForm.photos || dForm.photos.length < 5) && (
                                            <label className="w-24 h-24 bg-slate-50 rounded-xl border-2 border-dashed border-slate-200 flex items-center justify-center cursor-pointer text-2xl opacity-30 flex-shrink-0">
                                                ＋ <input type="file" accept="image/*" multiple className="hidden" onChange={handlePhotoUpload} />
                                            </label>
                                        )}
                                    </div>
                                </div>

                                <div>
                                    <label className="label-cap">Report Details</label>
                                    <textarea className="form-textarea h-64" placeholder="Full report contents..." 
                                              value={dForm.content} onChange={e => setDForm({...dForm, content: e.target.value})} required></textarea>
                                </div>

                                <button className="w-full bg-slate-900 text-white py-6 rounded-[2rem] font-black text-xl shadow-xl uppercase italic active:scale-95 transition-all">Update Log</button>
                            </form>
                        </div>
                    )}
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<DiaryApp />);
    </script>
</body>
</html>
