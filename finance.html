<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HSDEC Finance Pro</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background: #f8fafc; }
        .form-input, .form-select { border: 2px solid #e2e8f0; padding: 12px; border-radius: 12px; width: 100%; font-weight: 700; outline: none; }
        .label-cap { font-size: 10px; font-weight: 900; color: #94a3b8; text-transform: uppercase; margin-bottom: 4px; display: block; }
        .modal-full { position: fixed; inset: 0; background: white; z-index: 1000; overflow-y: auto; padding: 20px; }
        .rate-card { background: white; padding: 8px 12px; border-radius: 12px; border: 1px solid #e2e8f0; text-align: center; }
        .amount-text { font-family: 'Inter', sans-serif; font-weight: 900; letter-spacing: -0.05em; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const SUPABASE_URL = 'https://zgmqllufmqanixgwdjok.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_vOgl-K0RTxyK9i0WJp7UwA_PlwVgESz';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const PAYER_LIST = ["Mr. Chanthaviphone", "Ms. Sengmala", "Mr. Takashi", "Ms. Chansouk", "Ms. Mim", "Other"];
        const CATEGORIES = ["Gasoline", "Office Supplies", "Equipment", "Food/Drink", "Transport", "Repair", "Other"];

        function FinanceApp() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('list');
            const [records, setRecords] = useState([]);
            const [fForm, setFForm] = useState({});
            const [searchTerm, setSearchTerm] = useState('');
            const [rates, setRates] = useState({ lak: 22000, thb: 35.5, cny: 7.2 }); // „Éá„Éï„Ç©„É´„Éà„É¨„Éº„Éà

            useEffect(() => {
                const savedUser = localStorage.getItem('hsdec_user');
                if (savedUser) setUser(JSON.parse(savedUser));
                else window.location.href = 'index.html';
                fetchRecords();
            }, []);

            const fetchRecords = async () => {
                const { data } = await supabase.from('finance').select('*').order('date', { ascending: false });
                if (data) setRecords(data);
            };

            const handlePhoto = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 400;
                        let width = img.width, height = img.height;
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        setFForm({...fForm, photo_url: canvas.toDataURL('image/jpeg', 0.5)});
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            };

            const handleSave = async (e) => {
                e.preventDefault();
                const payload = { ...fForm, total: Number(fForm.unit_price || 0), recorded_by: user.name };
                const { error } = await supabase.from('finance').upsert([payload]);
                if(!error) { setView('list'); fetchRecords(); }
            };

            // Ê§úÁ¥¢„Å®ÂêàË®àË®àÁÆó
            const filteredRecords = records.filter(r => 
                r.item_name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                r.staff_name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                (r.category && r.category.toLowerCase().includes(searchTerm.toLowerCase()))
            );

            const totalSum = filteredRecords.reduce((acc, curr) => acc + Number(curr.total || 0), 0);

            if (!user) return null;

            return (
                <div className="max-w-4xl mx-auto p-4 pb-20">
                    {/* üíπ RATE DISPLAY & TOTAL SUMMARY */}
                    <div className="bg-slate-900 text-white rounded-[2.5rem] p-8 mb-6 shadow-2xl">
                        <div className="flex justify-between items-start mb-6">
                            <div>
                                <p className="text-[10px] font-black uppercase opacity-60 tracking-widest">Total Filtered Expense</p>
                                <h2 className="amount-text text-5xl text-rose-400">-${totalSum.toLocaleString()}</h2>
                            </div>
                            <button onClick={() => { 
                                setFForm({type:'Expense', date: new Date().toISOString().split('T')[0], method:'Cash', quantity:1, unit_price: 0, staff_name: PAYER_LIST[0], category: 'Gasoline'}); 
                                setView('edit'); 
                            }} className="bg-white text-black px-6 py-4 rounded-2xl font-black text-xs uppercase shadow-lg">Add Receipt</button>
                        </div>
                        
                        <div className="grid grid-cols-3 gap-3">
                            <div className="rate-card bg-slate-800 border-none text-white">
                                <p className="text-[8px] font-black opacity-50 uppercase text-blue-300">USD / LAK</p>
                                <p className="font-black italic">{rates.lak.toLocaleString()}</p>
                            </div>
                            <div className="rate-card bg-slate-800 border-none text-white">
                                <p className="text-[8px] font-black opacity-50 uppercase text-emerald-300">USD / THB</p>
                                <p className="font-black italic">{rates.thb}</p>
                            </div>
                            <div className="rate-card bg-slate-800 border-none text-white">
                                <p className="text-[8px] font-black opacity-50 uppercase text-yellow-300">USD / CNY</p>
                                <p className="font-black italic">{rates.cny}</p>
                            </div>
                        </div>
                    </div>

                    {/* üîç SEARCH BAR */}
                    <div className="relative mb-6">
                        <input 
                            type="text" 
                            className="form-input shadow-sm pl-12 py-5 italic text-lg border-none" 
                            placeholder="Search Gasoline, Takashi, Food..." 
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                        />
                        <span className="absolute left-4 top-5 text-xl">üîç</span>
                    </div>

                    {/* üìã LIST */}
                    <div className="grid grid-cols-1 gap-2">
                        {filteredRecords.map(r => (
                            <div key={r.id} onClick={() => { setFForm(r); setView('edit'); }} className="bg-white p-5 rounded-3xl border border-slate-100 flex justify-between items-center cursor-pointer hover:scale-[1.01] transition-all">
                                <div className="flex gap-4 items-center">
                                    <div className="w-14 h-14 bg-slate-50 rounded-2xl overflow-hidden border">
                                        {r.photo_url ? <img src={r.photo_url} className="w-full h-full object-cover" /> : <div className="flex items-center justify-center h-full text-[8px] font-black text-slate-200 uppercase">No Img</div>}
                                    </div>
                                    <div>
                                        <p className="text-[9px] font-black text-slate-300 uppercase leading-none mb-1">{r.date} ‚Ä¢ {r.category}</p>
                                        <p className="font-black text-slate-800 text-base">{r.item_name}</p>
                                        <p className="text-[9px] font-bold text-blue-500 uppercase tracking-widest mt-1">{r.staff_name}</p>
                                    </div>
                                </div>
                                <div className="text-right">
                                    <p className="amount-text text-xl text-rose-500">-${Number(r.total).toLocaleString()}</p>
                                    <p className="text-[9px] font-black text-slate-300 uppercase">{r.method}</p>
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* ‚úçÔ∏è EDIT VIEW (ÂâçÂõûÂêåÊßò) */}
                    {view === 'edit' && (
                        <div className="modal-full">
                            <div className="max-w-xl mx-auto pb-10">
                                <div className="flex justify-between items-center mb-6">
                                    <button onClick={() => setView('list')} className="text-slate-400 font-black text-xs uppercase tracking-widest">‚Üê Cancel</button>
                                    <span className="font-black italic text-xs uppercase text-blue-600 tracking-tighter">Finance Entry Detail</span>
                                </div>
                                <form onSubmit={handleSave} className="space-y-4">
                                    <div className="relative w-full aspect-[4/3] bg-slate-100 rounded-[2.5rem] border-4 border-dashed border-slate-200 overflow-hidden">
                                        {fForm.photo_url ? <img src={fForm.photo_url} className="w-full h-full object-contain" /> : <div className="flex items-center justify-center h-full text-slate-300 text-4xl">üì∑</div>}
                                        <input type="file" accept="image/*" capture="environment" className="absolute inset-0 opacity-0 cursor-pointer" onChange={handlePhoto} />
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div><label className="label-cap">Date</label><input type="date" className="form-input" value={fForm.date} onChange={e => setFForm({...fForm, date: e.target.value})} required /></div>
                                        <div><label className="label-cap">Category</label><select className="form-select" value={fForm.category} onChange={e => setFForm({...fForm, category: e.target.value})}>{CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}</select></div>
                                    </div>
                                    <div><label className="label-cap">Description</label><input type="text" className="form-input" value={fForm.item_name} onChange={e => setFForm({...fForm, item_name: e.target.value})} required /></div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div><label className="label-cap">Payer</label><select className="form-select" value={fForm.staff_name} onChange={e => setFForm({...fForm, staff_name: e.target.value})}>{PAYER_LIST.map(p => <option key={p} value={p}>{p}</option>)}</select></div>
                                        <div><label className="label-cap">Price ($)</label><input type="number" className="form-input font-black text-rose-500 text-xl text-right" value={fForm.unit_price} onChange={e => setFForm({...fForm, unit_price: e.target.value})} required /></div>
                                    </div>
                                    <button className="w-full bg-blue-600 text-white py-6 rounded-[2rem] font-black text-xl shadow-xl active:scale-95 transition-all uppercase italic">Save Transaction</button>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<FinanceApp />);
    </script>
</body>
</html>
