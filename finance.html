<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HSDEC Finance | LAK Accounting Sync</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; color: #0f172a; }
        .form-input, .form-select, .form-textarea { border: 2px solid #e2e8f0; padding: 12px; border-radius: 12px; width: 100%; font-weight: 900; outline: none; }
        .label-cap { font-size: 10px; font-weight: 900; color: #94a3b8; text-transform: uppercase; margin-bottom: 4px; display: block; }
        .modal-full { position: fixed; inset: 0; background: white; z-index: 1000; overflow-y: auto; padding: 20px; }
        .lak-amount { font-family: 'Inter', sans-serif; font-weight: 900; letter-spacing: -0.02em; }
        .sync-active { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const SUPABASE_URL = 'https://zgmqllufmqanixgwdjok.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_vOgl-K0RTxyK9i0WJp7UwA_PlwVgESz';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ‚ö†Ô∏è „ÅÇ„Å™„Åü„ÅÆGAS„ÅÆURL„Å´Â∑Æ„ÅóÊõø„Åà„Å¶„Åè„Å†„Åï„ÅÑ
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwpgtJZxwmnPHSXnMcOrvHkm1OjylOCLHEMEHghoL3iAcSry9QcTiSE29EPebxg0ig/exec';

        const CATEGORIES = [
            "‡∫ô‡ªâ‡∫≥‡∫°‡∫±‡∫ô‡∫•‡∫ª‡∫î / Gas / petro",
            "‡∫≠‡∫∏‡∫õ‡∫∞‡∫Å‡∫≠‡∫ô‡∫™‡∫≥‡∫ô‡∫±‡∫Å‡∫á‡∫≤‡∫ô / Office supplies",
            "‡∫≠‡∫∏‡∫õ‡∫∞‡∫Å‡∫≠‡∫ô‡ªÅ‡ªÅ‡∫Æ‡∫á‡∫á‡∫≤‡∫ô / Equipment WK",
            "‡∫≠‡∫≤‡∫´‡∫≤‡∫ô / ‡ªÄ‡∫Ñ‡∫∑‡ªà‡∫≠‡∫á‡∫î‡∫∑‡ªà‡∫° / food / drink",
            "‡∫Å‡∫≤‡∫ô‡∫Ç‡∫ª‡∫ô‡∫™‡∫ª‡ªà‡∫á / Transport",
            "‡∫≠‡∫∑‡ªà‡∫ô‡ªÜ / Other"
        ];
        const METHODS = ["‡ªÇ‡∫≠‡∫ô‡ªÄ‡∫á‡∫¥‡∫ô / Transfer", "‡ªÄ‡∫á‡∫¥‡∫ô‡∫™‡∫ª‡∫î / Cash"];

        function FinanceApp() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('list');
            const [records, setRecords] = useState([]);
            const [fForm, setFForm] = useState({});
            const [searchTerm, setSearchTerm] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [rates] = useState({ usd: 22000, thb: 620 }); 

            useEffect(() => {
                const savedUser = localStorage.getItem('hsdec_user');
                if (savedUser) {
                    setUser(JSON.parse(savedUser));
                    fetchSheetData();
                } else {
                    window.location.href = 'index.html';
                }
            }, []);

            const fetchSheetData = async () => {
                setIsLoading(true);
                try {
                    const response = await fetch(GAS_URL);
                    const data = await response.json();
                    // „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„ÅÆÈ†ÖÁõÆÂêç„ÇíÁèæÂú®„ÅÆ„Ç∑„Çπ„ÉÜ„É†„ÅÆ„Ç≠„ÉºÂêç„Å´„Éû„ÉÉ„Éî„É≥„Ç∞
                    const mapped = data.map(r => ({
                        ...r,
                        id: r.row_index, // „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„ÅÆË°åÁï™Âè∑„ÇíID‰ª£„Çè„Çä„Å´„Åô„Çã
                        date: r["‡∫ß‡∫±‡∫ô‡∫ó‡∫µ /Date."],
                        item_name: r["‡∫•‡∫≤‡∫ç‡∫Å‡∫≤‡∫ô / Item."],
                        category: r["‡∫õ‡∫∞‡ªÄ‡∫û‡∫î / Category."],
                        total: r["‡∫•‡∫ß‡∫° / Total."],
                        method: r["‡∫ß‡∫¥‡∫ó‡∫µ‡∫à‡ªà‡∫≤‡∫ç‡ªÄ‡∫á‡∫¥‡∫ô / Payment Method."],
                        photo_url: r["Photo"] || r.photo_url
                    }));
                    setRecords(mapped.reverse());
                } catch (err) { console.error("Fetch error:", err); }
                setIsLoading(false);
            };

            const handlePhoto = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 500;
                        let width = img.width, height = img.height;
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        setFForm({...fForm, photo_url: canvas.toDataURL('image/jpeg', 0.5)});
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            };

            const handleSave = async (e) => {
                e.preventDefault();
                setIsLoading(true);

                // GAS„Å´ÈÄÅ„Çã„Åü„ÇÅ„ÅÆ„Éá„Éº„ÇøÊï¥ÂΩ¢
                const payload = {
                    row_index: fForm.id || null,
                    no: fForm.no || records.length + 1,
                    date: fForm.date,
                    category: fForm.category,
                    method: fForm.method,
                    total: fForm.total,
                    item: fForm.item_name,
                    qty: fForm.qty || "1",
                    price: fForm.price || fForm.total,
                    amount: fForm.total,
                    memo: fForm.memo || "",
                    photo_url: fForm.photo_url || ""
                };

                try {
                    // 1. „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà(GAS)„Å∏‰øùÂ≠ò
                    await fetch(GAS_URL, {
                        method: 'POST',
                        mode: 'no-cors', // ÈáçË¶Å
                        body: JSON.stringify(payload)
                    });

                    // 2. Supabase„Å∏„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó‰øùÂ≠ò (‰ªªÊÑè)
                    await supabase.from('finance').upsert({
                        date: fForm.date,
                        item_name: fForm.item_name,
                        total: fForm.total,
                        photo_url: fForm.photo_url
                    });

                    alert("‚úÖ Success! Syncing to Sheets...");
                    setView('list');
                    setTimeout(fetchSheetData, 1500); // ÂèçÊò†„ÇíÂæÖ„Å£„Å¶ÂÜçÂèñÂæó
                } catch (error) {
                    alert("Error: " + error.message);
                }
                setIsLoading(false);
            };

            const filteredRecords = records.filter(r => 
                String(r.item_name || "").toLowerCase().includes(searchTerm.toLowerCase())
            );

            const totalLak = filteredRecords.reduce((acc, curr) => acc + Number(curr.total || 0), 0);

            if (!user) return null;

            return (
                <div className="max-w-4xl mx-auto p-4 pb-20">
                    {/* üá±üá¶ DASHBOARD */}
                    <div className="bg-emerald-900 text-white rounded-[2.5rem] p-8 mb-6 shadow-2xl relative overflow-hidden">
                        <div className="relative z-10">
                            <div className="flex justify-between items-start mb-4">
                                <div>
                                    <p className="text-[10px] font-black uppercase opacity-60 tracking-widest flex items-center gap-2">
                                        Total Expenses (LAK) {isLoading && <span className="w-2 h-2 bg-emerald-400 rounded-full sync-active"></span>}
                                    </p>
                                    <h2 className="lak-amount text-4xl md:text-5xl text-emerald-300">
                                        {totalLak.toLocaleString()} <span className="text-sm font-normal">‚Ç≠</span>
                                    </h2>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={fetchSheetData} className="bg-emerald-800 text-white p-3 rounded-2xl">üîÑ</button>
                                    <button onClick={() => { 
                                        setFForm({date: new Date().toISOString().split('T')[0], category: CATEGORIES[0], method: METHODS[0]}); 
                                        setView('edit'); 
                                    }} className="bg-white text-emerald-900 px-5 py-3 rounded-2xl font-black text-xs uppercase shadow-lg">+ NEW</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* üîç SEARCH */}
                    <div className="relative mb-6">
                        <input type="text" className="form-input shadow-sm pl-12 py-5 italic text-lg border-none" placeholder="Search item description..." onChange={(e) => setSearchTerm(e.target.value)} />
                        <span className="absolute left-4 top-5 text-xl opacity-30">üîç</span>
                    </div>

                    {/* üìã LIST */}
                    <div className="grid grid-cols-1 gap-3">
                        {filteredRecords.map((r, i) => (
                            <div key={i} onClick={() => {
                                setFForm({
                                    id: r.row_index,
                                    no: r["‡∫•/‡∫î / No."],
                                    date: r.date,
                                    item_name: r.item_name,
                                    category: r.category,
                                    total: r.total,
                                    method: r.method,
                                    qty: r["‡∫à‡∫≥‡∫ô‡∫ß‡∫ô/Quantity."],
                                    price: r["‡∫•‡∫≤‡∫Ñ‡∫≤ / Price."],
                                    memo: r["Memo"],
                                    photo_url: r.photo_url
                                });
                                setView('edit');
                            }} className="bg-white p-5 rounded-3xl border border-slate-100 flex justify-between items-center cursor-pointer shadow-sm active:scale-95 transition-all">
                                <div className="flex gap-4 items-center">
                                    <div className="w-14 h-14 bg-slate-50 rounded-2xl overflow-hidden border border-slate-100 flex-shrink-0">
                                        {r.photo_url ? <img src={r.photo_url} className="w-full h-full object-cover" /> : <div className="flex items-center justify-center h-full text-[8px] font-black text-slate-200 uppercase">No Image</div>}
                                    </div>
                                    <div>
                                        <p className="text-[9px] font-black text-slate-400 uppercase">{r.date}</p>
                                        <p className="font-black text-slate-800 text-base leading-tight">{r.item_name}</p>
                                        <span className="text-[9px] font-black bg-slate-100 px-2 py-0.5 rounded text-slate-500">{r.category}</span>
                                    </div>
                                </div>
                                <div className="text-right">
                                    <p className="lak-amount text-lg text-rose-600">-{Number(r.total).toLocaleString()}‚Ç≠</p>
                                    <p className="text-[8px] font-black text-slate-400 uppercase">{r.method}</p>
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* ‚úçÔ∏è EDIT/NEW VIEW */}
                    {view === 'edit' && (
                        <div className="modal-full">
                            <div className="max-w-xl mx-auto pb-10">
                                <header className="flex justify-between items-center mb-6">
                                    <button onClick={() => setView('list')} className="font-black text-xs text-slate-400 uppercase tracking-widest">‚Üê Back</button>
                                    <h2 className="font-black italic text-sm">TRANSACTION ENTRY</h2>
                                </header>
                                <form onSubmit={handleSave} className="space-y-4">
                                    <div className="relative w-full aspect-video bg-slate-50 rounded-[2rem] border-4 border-dashed border-slate-200 overflow-hidden flex items-center justify-center">
                                        {fForm.photo_url ? <img src={fForm.photo_url} className="w-full h-full object-contain" /> : <span className="text-5xl opacity-20">üì∑</span>}
                                        <input type="file" accept="image/*" capture="environment" className="absolute inset-0 opacity-0" onChange={handlePhoto} />
                                    </div>

                                    <div className="grid grid-cols-2 gap-3">
                                        <div><label className="label-cap">Date</label><input type="date" className="form-input" value={fForm.date} onChange={e => setFForm({...fForm, date: e.target.value})} required /></div>
                                        <div><label className="label-cap">Category</label>
                                            <select className="form-select" value={fForm.category} onChange={e => setFForm({...fForm, category: e.target.value})}>
                                                {CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}
                                            </select>
                                        </div>
                                    </div>

                                    <div><label className="label-cap">Item Description</label><input type="text" className="form-input" value={fForm.item_name} placeholder="What did you buy?" onChange={e => setFForm({...fForm, item_name: e.target.value})} required /></div>

                                    <div className="grid grid-cols-3 gap-3">
                                        <div><label className="label-cap">Qty</label><input type="text" className="form-input" value={fForm.qty} onChange={e => setFForm({...fForm, qty: e.target.value})} /></div>
                                        <div><label className="label-cap">Price</label><input type="number" className="form-input" value={fForm.price} onChange={e => setFForm({...fForm, price: e.target.value})} /></div>
                                        <div><label className="label-cap">Total (LAK)</label><input type="number" className="form-input text-rose-600" value={fForm.total} onChange={e => setFForm({...fForm, total: e.target.value})} required /></div>
                                    </div>

                                    <div><label className="label-cap">Payment Method</label>
                                        <select className="form-select" value={fForm.method} onChange={e => setFForm({...fForm, method: e.target.value})}>
                                            {METHODS.map(m => <option key={m} value={m}>{m}</option>)}
                                        </select>
                                    </div>

                                    <div><label className="label-cap">Memo / Note</label><textarea className="form-textarea h-24" value={fForm.memo} onChange={e => setFForm({...fForm, memo: e.target.value})} placeholder="Free memo here..."></textarea></div>

                                    <button disabled={isLoading} className="w-full bg-emerald-900 text-white py-6 rounded-[2rem] font-black text-xl shadow-xl active:scale-95 transition-all uppercase italic">
                                        {isLoading ? "Syncing..." : "Save Transaction"}
                                    </button>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<FinanceApp />);
    </script>
</body>
</html>
