<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HSDEC Korean Worker Management System</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Lao:wght@400;600;700&display=swap');

* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
    font-family: 'Segoe UI', sans-serif; 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
    min-height: 100vh; 
    padding: 20px; 
}
    
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; border-radius: 20px 20px 0 0; }
        h1 { font-size: 2.5em; margin-bottom: 10px; }
        .tabs { display: flex; background: #f5f5f5; border-bottom: 2px solid #ddd; }
        .tab { flex: 1; padding: 20px; text-align: center; cursor: pointer; font-size: 1.1em; font-weight: 600; transition: all 0.3s; border: none; background: none; }
        .tab:hover { background: #e0e0e0; }
        .tab.active { background: white; color: #667eea; border-bottom: 3px solid #667eea; }
        .content { padding: 30px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        input, select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em; }
        input:focus, select:focus { outline: none; border-color: #667eea; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 40px; border: none; border-radius: 8px; font-size: 1.1em; font-weight: 600; cursor: pointer; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .btn-danger { background: linear-gradient(135deg, #f44336 0%, #e91e63 100%); }
        .search-box { display: flex; gap: 10px; margin-bottom: 30px; }
        .search-box input { flex: 1; }
        .Worker-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .Worker-card { border: 2px solid #ddd; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s; }
        .Worker-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-color: #667eea; }
        .Worker-photo { width: 100%; height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 15px; background: #f0f0f0; }
        .Worker-name { font-size: 1.3em; font-weight: 600; margin-bottom: 10px; }
        .Worker-info { color: #666; line-height: 1.6; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; }
        .modal.active { display: flex; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; border-radius: 20px; padding: 40px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #ddd; }
        .close-btn { background: none; border: none; font-size: 2em; cursor: pointer; color: #999; }
        .detail-section { margin-bottom: 30px; }
        .detail-section h3 { color: #667eea; margin-bottom: 15px; font-size: 1.3em; }
        .detail-row { display: grid; grid-template-columns: 150px 1fr; gap: 10px; margin-bottom: 10px; padding: 10px; background: #f9f9f9; border-radius: 8px; }
        .detail-label { font-weight: 600; }
        .pdf-link { display: block; padding: 15px; background: #f0f0f0; border-radius: 8px; text-decoration: none; color: #333; margin-bottom: 10px; }
        .pdf-link:hover { background: #667eea; color: white; }
        .pdf-link.empty { opacity: 0.5; pointer-events: none; }
        .success-message { background: #4caf50; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .success-message.show { display: block; }
        .filter-btn { padding: 10px 20px; background: #f0f0f0; border: 2px solid #ddd; border-radius: 20px; cursor: pointer; margin: 0 5px 10px 0; }
        .filter-btn.active { background: #667eea; color: white; border-color: #667eea; }
        .checkbox-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px; }
        .checkbox-item { display: flex; align-items: center; gap: 10px; padding: 12px; background: #f9f9f9; border-radius: 8px; }
        .checkbox-item input { width: 20px; height: 20px; }
        .checklist-item { display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: #f9f9f9; border-radius: 6px; margin-bottom: 8px; }
        .checklist-item.complete { background: #e8f5e9; }
        .checklist-item.incomplete { background: #ffebee; }
        .action-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .action-buttons .btn { flex: 1; }
        .Worker-card.selected { border-color: #667eea; background: #f0f4ff; }
        .Worker-checkbox { position: absolute; top: 10px; right: 10px; width: 20px; height: 20px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <header style="position:relative;">
    <div style="position:absolute;top:20px;right:20px;display:flex;gap:10px;">
        <button id="lang-ja" style="background:white;color:#667eea;border:2px solid white;padding:8px 15px;border-radius:8px;cursor:pointer;font-weight:600;">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</button>
<button id="lang-en" style="background:white;color:#667eea;border:2px solid white;padding:8px 15px;border-radius:8px;cursor:pointer;font-weight:600;">ğŸ‡¬ğŸ‡§ English</button>
<button id="lang-lo" style="background:white;color:#667eea;border:2px solid white;padding:8px 15px;border-radius:8px;cursor:pointer;font-weight:600;">ğŸ‡±ğŸ‡¦ àº¥àº²àº§</button>
    </div>
    <h1>
        <img src="https://raw.githubusercontent.com/hsdecla-svg/HSDEC-management-system/main/HSDB-logo.png" style="height:60px;vertical-align:middle;margin-right:15px;border-radius:8px;">
        <span data-i18n="title">ğŸ¢ HSDEC éŸ“å›½åŠ´åƒè€…ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </span>
    </h1>
    <p data-i18n="subtitle">Korean Worker Management System</p>
</header>
        
        <div class="tabs">
     <button class="tab active" data-tab="list" data-i18n="tabList">ğŸ“‹ ä¸€è¦§</button>
    <button class="tab" data-tab="add" data-i18n="tabAdd">â• ç™»éŒ²</button>
    <button class="tab" data-tab="stats" data-i18n="tabStats">ğŸ“Š çµ±è¨ˆ</button>
</div>
        
        <div class="content">
            <div id="list-tab" class="tab-content active">
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="ğŸ” åå‰ã§æ¤œç´¢...">
                    <button class="btn" id="search-btn">æ¤œç´¢</button>
                </div>
                <div id="batch-filters" style="margin-bottom:20px;"></div>
                <div id="Worker-list" class="Worker-grid"></div>
                <div id="no-results" style="display:none;text-align:center;padding:40px;color:#999;">è©²å½“ãªã—</div>
            </div>

            <div style="margin-bottom:20px;display:flex;gap:10px;align-items:center;">
    <button class="btn btn-success btn-small" onclick="exportExcel()">ğŸ“¥ Excelå‡ºåŠ›</button>
    <button class="btn btn-success btn-small" onclick="exportCSV()">ğŸ“„ CSVå‡ºåŠ›</button>
    <button class="btn btn-danger btn-small" id="bulk-delete-btn" style="display:none;" onclick="bulkDelete()">ğŸ—‘ï¸ é¸æŠã‚’å‰Šé™¤</button>
    <label style="margin-left:auto;">
        <input type="checkbox" id="select-mode" onchange="toggleSelectMode()"> é¸æŠãƒ¢ãƒ¼ãƒ‰
    </label>
</div>
            
            <div style="background:#f9f9f9;padding:20px;border-radius:12px;margin-bottom:20px;">
  <h3 style="margin-bottom:15px" data-i18n="advSearch">ğŸ” é«˜åº¦ãªæ¤œç´¢</h3>
    <div class="form-row">
        <input type="text" id="adv-name" data-placeholder="searchName" placeholder="åå‰">
<input type="text" id="adv-passport" data-placeholder="searchPassport" placeholder="ãƒ‘ã‚¹ãƒãƒ¼ãƒˆç•ªå·">
<select id="adv-batch" data-first-option="searchAllBatch">
    <option value="">å…¨ã¦ã®æœŸ</option>
</select>
    </div>
    <div class="form-row" style="margin-top:10px;">
        <input type="date" id="adv-date-from" placeholder="å¥‘ç´„é–‹å§‹æ—¥(ã‹ã‚‰)">
        <input type="date" id="adv-date-to" placeholder="å¥‘ç´„é–‹å§‹æ—¥(ã¾ã§)">
        <select id="adv-docs">
            <option value="">æ›¸é¡çŠ¶æ³</option>
            <option value="complete">å…¨ã¦æå‡ºæ¸ˆ</option>
            <option value="incomplete">æœªæå‡ºã‚ã‚Š</option>
        </select>
    </div>
    <button class="btn btn-small" onclick="advSearch()" style="margin-top:10px" data-i18n="btnSearch">æ¤œç´¢å®Ÿè¡Œ</button>
<button class="btn btn-secondary btn-small" onclick="clearAdv()" style="margin-top:10px" data-i18n="btnClear">ã‚¯ãƒªã‚¢</button>
</div>
            
            <div id="add-tab" class="tab-content">
                <div class="success-message" id="success-message">âœ… ç™»éŒ²å®Œäº†ï¼</div>
                <form id="Worker-form">
                    <h2 style="margin-bottom:30px;">åŸºæœ¬æƒ…å ±</h2>
                    <div class="form-row">
                        <div class="form-group"><label>åå‰ *</label><input type="text" name="name" required></div>
                        <div class="form-group"><label>ç”Ÿå¹´æœˆæ—¥</label><input type="date" name="birth_date"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>æ€§åˆ¥</label><select name="gender"><option value="">é¸æŠ</option><option value="ç”·æ€§">ç”·æ€§</option><option value="å¥³æ€§">å¥³æ€§</option></select></div>
                        <div class="form-group"><label>å›½ç±</label><input type="text" name="nationality" value="Laos"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>ãƒ‘ã‚¹ãƒãƒ¼ãƒˆç•ªå·</label><input type="text" name="passport_number"></div>
                        <div class="form-group"><label>é›»è©±ç•ªå·</label><input type="text" name="phone_number"></div>
                    </div>
                    <h2 style="margin:40px 0 30px;">æœŸãƒ»æ—¥ä»˜æƒ…å ±</h2>
                    <div class="form-row">
                        <div class="form-group"><label>ç¬¬â—‹æœŸç”Ÿ</label><input type="text" name="batch" placeholder="ä¾‹:ç¬¬3æœŸç”Ÿ"></div>
                        <div class="form-group"><label>é¢æ¥æ—¥</label><input type="date" name="interview_date"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>KITå‹‰å¼·é–‹å§‹æ—¥</label><input type="date" name="kit_start_date"></div>
                        <div class="form-group"><label>å¥‘ç´„é–‹å§‹æ—¥</label><input type="date" name="contract_start"></div>
                    </div>
                    <div class="form-group"><label>å¥‘ç´„çµ‚äº†æ—¥</label><input type="date" name="contract_end"></div>
                    <h2 style="margin:40px 0 20px;">ğŸ“‹ æ›¸é¡ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h2>
                    <div class="checkbox-group">
                        <div class="checkbox-item"><input type="checkbox" name="has_passport" id="p1"><label for="p1">ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ</label></div>
                        <div class="checkbox-item"><input type="checkbox" name="has_idcard" id="p2"><label for="p2">IDã‚«ãƒ¼ãƒ‰</label></div>
                        <div class="checkbox-item"><input type="checkbox" name="has_health_check" id="p3"><label for="p3">å¥åº·è¨ºæ–­æ›¸</label></div>
                        <div class="checkbox-item"><input type="checkbox" name="has_contract" id="p4"><label for="p4">åŠ´åƒå¥‘ç´„æ›¸</label></div>
                        <div class="checkbox-item"><input type="checkbox" name="has_visa" id="p5"><label for="p5">ãƒ“ã‚¶</label></div>
                        <div class="checkbox-item"><input type="checkbox" name="has_insurance" id="p6"><label for="p6">ä¿é™ºè¨¼</label></div>
                    </div>
                    <h2 style="margin:40px 0 30px;">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«URL</h2>
                    <div class="form-group"><label>é¡”å†™çœŸURL</label><input type="url" name="photo_url"></div>
                    <div class="form-group"><label>ãƒ‘ã‚¹ãƒãƒ¼ãƒˆPDF</label><input type="url" name="passport_pdf_url"></div>
                    <div class="form-group"><label>IDã‚«ãƒ¼ãƒ‰PDF</label><input type="url" name="idcard_pdf_url"></div>
                    <div class="form-group"><label>å¥åº·è¨ºæ–­æ›¸PDF</label><input type="url" name="health_check_pdf_url"></div>
                    <button type="submit" class="btn" style="margin-top:30px;width:100%;">âœ… ç™»éŒ²</button>
                </form>
            </div>
            <div id="stats-tab" class="tab-content">
            <h2 style="margin-bottom:30px;">ğŸ“Š çµ±è¨ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
            
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px;">
                <div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:30px;border-radius:12px;text-align:center;">
                    <div style="font-size:3em;font-weight:bold;margin-bottom:10px;" id="stat-total">0</div>
                    <div style="font-size:1.2em;opacity:0.9;">ç·åŠ´åƒè€…æ•°</div>
                </div>
                <div style="background:linear-gradient(135deg,#4caf50 0%,#66bb6a 100%);color:white;padding:30px;border-radius:12px;text-align:center;">
                    <div style="font-size:3em;font-weight:bold;margin-bottom:10px;" id="stat-complete">0%</div>
                    <div style="font-size:1.2em;opacity:0.9;">æ›¸é¡å®Œäº†ç‡</div>
                </div>
                <div style="background:linear-gradient(135deg,#ff9800 0%,#ffa726 100%);color:white;padding:30px;border-radius:12px;text-align:center;">
                    <div style="font-size:3em;font-weight:bold;margin-bottom:10px;" id="stat-recent">0</div>
                    <div style="font-size:1.2em;opacity:0.9;">ä»Šæœˆã®ç™»éŒ²</div>
                </div>
            </div>
            
            <div style="background:white;padding:20px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.1);margin-bottom:20px;">
                <h3 style="margin-bottom:20px;">æœŸåˆ¥åŠ´åƒè€…æ•°</h3>
                <div id="batch-chart"></div>
            </div>
            
            <div style="background:white;padding:20px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.1);">
                <h3 style="margin-bottom:20px;">æ›¸é¡æå‡ºçŠ¶æ³</h3>
                <div id="docs-chart"></div>
            </div>
        </div>
        </div>
    </div>
    
    <div id="detail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>åŠ´åƒè€…è©³ç´°</h2><button class="close-btn" id="close-detail">&times;</button></div>
            <div id="detail-content"></div>
        </div>
    </div>
    
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>ç·¨é›†</h2><button class="close-btn" id="close-edit">&times;</button></div>
            <form id="edit-form"></form>
        </div>
    </div>

    <script>
window.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        if (typeof window.supabase === 'undefined') {
            console.error('Supabase library not loaded');
            alert('ã‚·ã‚¹ãƒ†ãƒ ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
            return;
        }
        
        initApp();
    }, 100);
});

function initApp() {
    const sb = window.supabase.createClient('https://zgmqllufmqanixgwdjok.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpnbXFsbHVmbXFhbml4Z3dkam9rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczMzk0MjAsImV4cCI6MjA4MjkxNTQyMH0.xg-5T7DfcW2enMAXvudNOMPbvvm1WSwRHGZ_Vpdyrrw');
    const translations = {
        ja: {
            title: 'ğŸ¢ HSDEC éŸ“å›½åŠ´åƒè€…ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ',
            subtitle: 'Korean Worker Management System',
            tabList: 'ğŸ“‹ ä¸€è¦§',
            tabAdd: 'â• ç™»éŒ²',
            tabStats: 'ğŸ“Š çµ±è¨ˆ',
            btnExcel: 'ğŸ“¥ Excelå‡ºåŠ›',
            btnCSV: 'ğŸ“„ CSVå‡ºåŠ›',
            btnBulkDelete: 'ğŸ—‘ï¸ é¸æŠã‚’å‰Šé™¤',
            selectMode: 'é¸æŠãƒ¢ãƒ¼ãƒ‰',
            advSearch: 'ğŸ” é«˜åº¦ãªæ¤œç´¢',
            searchName: 'åå‰',
            searchPassport: 'ãƒ‘ã‚¹ãƒãƒ¼ãƒˆç•ªå·',
            searchAllBatch: 'å…¨ã¦ã®æœŸ',
            searchDateFrom: 'å¥‘ç´„é–‹å§‹æ—¥(ã‹ã‚‰)',
            searchDateTo: 'å¥‘ç´„é–‹å§‹æ—¥(ã¾ã§)',
            searchDocs: 'æ›¸é¡çŠ¶æ³',
            searchDocsComplete: 'å…¨ã¦æå‡ºæ¸ˆ',
            searchDocsIncomplete: 'æœªæå‡ºã‚ã‚Š',
            btnSearch: 'æ¤œç´¢å®Ÿè¡Œ',
            btnClear: 'ã‚¯ãƒªã‚¢',
            noResults: 'è©²å½“ãªã—',
            formBasic: 'åŸºæœ¬æƒ…å ±',
            formName: 'åå‰',
            formBirthDate: 'ç”Ÿå¹´æœˆæ—¥',
            formGender: 'æ€§åˆ¥',
            formGenderSelect: 'é¸æŠ',
            formGenderMale: 'ç”·æ€§',
            formGenderFemale: 'å¥³æ€§',
            formNationality: 'å›½ç±',
            formPassport: 'ãƒ‘ã‚¹ãƒãƒ¼ãƒˆç•ªå·',
            formPhone: 'é›»è©±ç•ªå·',
            formPeriod: 'æœŸãƒ»æ—¥ä»˜æƒ…å ±',
            formBatch: 'ç¬¬â—‹æœŸç”Ÿ',
            formBatchPlaceholder: 'ä¾‹:ç¬¬3æœŸç”Ÿ',
            formInterview: 'é¢æ¥æ—¥',
            formKitStart: 'KITå‹‰å¼·é–‹å§‹æ—¥',
            formContractStart: 'å¥‘ç´„é–‹å§‹æ—¥',
            formContractEnd: 'å¥‘ç´„çµ‚äº†æ—¥',
            formDocs: 'ğŸ“‹ æ›¸é¡ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ',
            formDocPassport: 'ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ',
            formDocId: 'IDã‚«ãƒ¼ãƒ‰',
            formDocHealth: 'å¥åº·è¨ºæ–­æ›¸',
            formDocContract: 'åŠ´åƒå¥‘ç´„æ›¸',
            formDocVisa: 'ãƒ“ã‚¶',
            formDocInsurance: 'ä¿é™ºè¨¼',
            formFiles: 'ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«URL',
            formPhoto: 'é¡”å†™çœŸURL',
            formPassportPdf: 'ãƒ‘ã‚¹ãƒãƒ¼ãƒˆPDF',
            formIdPdf: 'IDã‚«ãƒ¼ãƒ‰PDF',
            formHealthPdf: 'å¥åº·è¨ºæ–­æ›¸PDF',
            btnRegister: 'âœ… ç™»éŒ²',
            successMsg: 'âœ… ç™»éŒ²å®Œäº†ï¼',
            statsTitle: 'ğŸ“Š çµ±è¨ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰',
            statTotal: 'ç·åŠ´åƒè€…æ•°',
            statComplete: 'æ›¸é¡å®Œäº†ç‡',
            statRecent: 'ä»Šæœˆã®ç™»éŒ²',
            statsByBatch: 'æœŸåˆ¥åŠ´åƒè€…æ•°',
            statsDocStatus: 'æ›¸é¡æå‡ºçŠ¶æ³',
            detailTitle: 'åŠ´åƒè€…è©³ç´°',
            detailBasic: 'ğŸ“‹ åŸºæœ¬æƒ…å ±',
            detailPeriod: 'ğŸ“… æœŸãƒ»æ—¥ä»˜',
            detailDocs: 'âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ',
            detailFiles: 'ğŸ“ æ›¸é¡',
            detailPeriodLabel: 'æœŸ',
            detailNotRegistered: '(æœªç™»éŒ²)',
            btnEdit: 'âœï¸ ç·¨é›†',
            btnPrint: 'ğŸ–¨ï¸ å°åˆ·',
            btnDelete: 'ğŸ—‘ï¸ å‰Šé™¤',
            editTitle: 'ç·¨é›†',
            btnSave: 'ğŸ’¾  ä¿å­˜',
            confirmDelete: 'æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ',
            confirmBulkDelete: 'ä»¶ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ',
            alertSelectItems: 'å‰Šé™¤ã™ã‚‹é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„',
            errorOccurred: 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: '
        },
        en: {
            title: 'ğŸ¢ HSDEC Korean Worker Management System',
            subtitle: 'Korean Worker Management System',
            tabList: 'ğŸ“‹ List',
            tabAdd: 'â• Register',
            tabStats: 'ğŸ“Š Statistics',
            btnExcel: 'ğŸ“¥ Excel Export',
            btnCSV: 'ğŸ“„ CSV Export',
            btnBulkDelete: 'ğŸ—‘ï¸ Delete Selected',
            selectMode: 'Selection Mode',
            advSearch: 'ğŸ” Advanced Search',
            searchName: 'Name',
            searchPassport: 'Passport Number',
            searchAllBatch: 'All Periods',
            searchDateFrom: 'Contract Start (From)',
            searchDateTo: 'Contract Start (To)',
            searchDocs: 'Document Status',
            searchDocsComplete: 'All Submitted',
            searchDocsIncomplete: 'Missing Documents',
            btnSearch: 'Search',
            btnClear: 'Clear',
            noResults: 'No Results',
            formBasic: 'Basic Information',
            formName: 'Name',
            formBirthDate: 'Date of Birth',
            formGender: 'Gender',
            formGenderSelect: 'Select',
            formGenderMale: 'Male',
            formGenderFemale: 'Female',
            formNationality: 'Nationality',
            formPassport: 'Passport Number',
            formPhone: 'Phone Number',
            formPeriod: 'Period & Date Information',
            formBatch: 'Period',
            formBatchPlaceholder: 'e.g., Period 3',
            formInterview: 'Interview Date',
            formKitStart: 'KIT Training Start',
            formContractStart: 'Contract Start',
            formContractEnd: 'Contract End',
            formDocs: 'ğŸ“‹ Document Checklist',
            formDocPassport: 'Passport',
            formDocId: 'ID Card',
            formDocHealth: 'Health Certificate',
            formDocContract: 'Labor Contract',
            formDocVisa: 'Visa',
            formDocInsurance: 'Insurance',
            formFiles: 'ğŸ“ File URLs',
            formPhoto: 'Photo URL',
            formPassportPdf: 'Passport PDF',
            formIdPdf: 'ID Card PDF',
            formHealthPdf: 'Health Certificate PDF',
            btnRegister: 'âœ… Register',
            successMsg: 'âœ… Registration Complete!',
            statsTitle: 'ğŸ“Š Statistics Dashboard',
            statTotal: 'Total Workers',
            statComplete: 'Document Completion Rate',
            statRecent: 'Registered This Month',
            statsByBatch: 'Workers by Period',
            statsDocStatus: 'Document Submission Status',
            detailTitle: 'Worker Details',
            detailBasic: 'ğŸ“‹ Basic Info',
            detailPeriod: 'ğŸ“… Period & Dates',
            detailDocs: 'âœ… Checklist',
            detailFiles: 'ğŸ“ Documents',
            detailPeriodLabel: 'Period',
            detailNotRegistered: '(Not Registered)',
            btnEdit: 'âœï¸ Edit',
            btnPrint: 'ğŸ–¨ï¸ Print',
            btnDelete: 'ğŸ—‘ï¸ Delete',
            editTitle: 'Edit',
            btnSave: 'ğŸ’¾ Save',
            confirmDelete: 'Are you sure you want to delete?',
            confirmBulkDelete: ' items will be deleted. Continue?',
            alertSelectItems: 'Please select items to delete',
            errorOccurred: 'Error occurred: '
        },
        lo: {
            title: 'ğŸ¢ àº¥àº°àºšàº»àºšàº„àº¸à»‰àº¡àº„àº­àº‡à»àº®àº‡àº‡àº²àº™à»€àºàº»àº²àº«àº¼àºµ HSDEC',
            subtitle: 'àº¥àº°àºšàº»àºšàº„àº¸à»‰àº¡àº„àº­àº‡à»àº®àº‡àº‡àº²àº™à»€àºàº»àº²àº«àº¼àºµ',
            tabList: 'ğŸ“‹ àº¥àº²àºàºàº²àº™',
            tabAdd: 'â• àº¥àº»àº‡àº—àº°àºšàº½àº™',
            tabStats: 'ğŸ“Š àºªàº°àº–àº´àº•àº´',
            btnExcel: 'ğŸ“¥ àºªàº»à»ˆàº‡àº­àº­àº Excel',
            btnCSV: 'ğŸ“„ àºªàº»à»ˆàº‡àº­àº­àº CSV',
            btnBulkDelete: 'ğŸ—‘ï¸ àº¥àº¶àºšàº—àºµà»ˆà»€àº¥àº·àº­àº',
            selectMode: 'à»‚à»àº”à»€àº¥àº·àº­àº',
            advSearch: 'ğŸ” àº„àº»à»‰àº™àº«àº²àº‚àº±à»‰àº™àºªàº¹àº‡',
            searchName: 'àºŠàº·à»ˆ',
            searchPassport: 'à»€àº¥àºà»œàº±àº‡àºªàº·àºœà»ˆàº²àº™à»àº”àº™',
            searchAllBatch: 'àº—àº¸àºàº¥àº¸à»‰àº™',
            searchDateFrom: 'àº§àº±àº™à»€àº¥àºµà»ˆàº¡àºªàº±àº™àºàº² (àºˆàº²àº)',
            searchDateTo: 'àº§àº±àº™à»€àº¥àºµà»ˆàº¡àºªàº±àº™àºàº² (àº«àº²)',
            searchDocs: 'àºªàº°àº–àº²àº™àº°à»€àº­àºàº°àºªàº²àº™',
            searchDocsComplete: 'àºªàº»à»ˆàº‡àº„àº»àºšà»àº¥à»‰àº§',
            searchDocsIncomplete: 'àºàº±àº‡àºšà»à»ˆàº„àº»àºš',
            btnSearch: 'àº„àº»à»‰àº™àº«àº²',
            btnClear: 'àº¥àº¶àºšàº¥à»‰àº²àº‡',
            noResults: 'àºšà»à»ˆàºàº»àºšàº‚à»à»‰àº¡àº¹àº™',
            formBasic: 'àº‚à»à»‰àº¡àº¹àº™àºàº·à»‰àº™àº–àº²àº™',
            formName: 'àºŠàº·à»ˆ',
            formBirthDate: 'àº§àº±àº™à»€àº”àº·àº­àº™àº›àºµà»€àºàºµàº”',
            formGender: 'à»€àºàº”',
            formGenderSelect: 'à»€àº¥àº·àº­àº',
            formGenderMale: 'àºŠàº²àº',
            formGenderFemale: 'àºàº´àº‡',
            formNationality: 'àºªàº±àº™àºŠàº²àº”',
            formPassport: 'à»€àº¥àºà»œàº±àº‡àºªàº·àºœà»ˆàº²àº™à»àº”àº™',
            formPhone: 'à»€àºšàºµà»‚àº—àº¥àº°àºªàº±àºš',
            formPeriod: 'àº‚à»à»‰àº¡àº¹àº™àº¥àº¸à»‰àº™ à»àº¥àº° àº§àº±àº™àº—àºµ',
            formBatch: 'àº¥àº¸à»‰àº™àº—àºµà»ˆ',
            formBatchPlaceholder: 'àº•àº»àº§àº¢à»ˆàº²àº‡: àº¥àº¸à»‰àº™àº—àºµ 3',
            formInterview: 'àº§àº±àº™àºªàº³àºàº²àº”',
            formKitStart: 'àº§àº±àº™à»€àº¥àºµà»ˆàº¡àº®àº½àº™ KIT',
            formContractStart: 'àº§àº±àº™à»€àº¥àºµà»ˆàº¡àºªàº±àº™àºàº²',
            formContractEnd: 'àº§àº±àº™àºªàº´à»‰àº™àºªàº¸àº”àºªàº±àº™àºàº²',
            formDocs: 'ğŸ“‹ àº¥àº²àºàºàº²àº™àºàº§àº”à»€àº­àºàº°àºªàº²àº™',
            formDocPassport: 'à»œàº±àº‡àºªàº·àºœà»ˆàº²àº™à»àº”àº™',
            formDocId: 'àºšàº±àº”àº›àº°àºˆàº³àº•àº»àº§',
            formDocHealth: 'à»ƒàºšàºàº§àº”àºªàº¸àº‚àº°àºàº²àºš',
            formDocContract: 'àºªàº±àº™àºàº²àºˆà»‰àº²àº‡àº‡àº²àº™',
            formDocVisa: 'àº§àºµàºŠàº²',
            formDocInsurance: 'àº›àº°àºàº±àº™à»„àº',
            formFiles: 'ğŸ“ URL à»„àºŸàº¥à»Œ',
            formPhoto: 'URL àº®àº¹àºšàºàº²àºš',
            formPassportPdf: 'PDF à»œàº±àº‡àºªàº·àºœà»ˆàº²àº™à»àº”àº™',
            formIdPdf: 'PDF àºšàº±àº”àº›àº°àºˆàº³àº•àº»àº§',
            formHealthPdf: 'PDF à»ƒàºšàºàº§àº”àºªàº¸àº‚àº°àºàº²àºš',
            btnRegister: 'âœ… àº¥àº»àº‡àº—àº°àºšàº½àº™',
            successMsg: 'âœ… àº¥àº»àº‡àº—àº°àºšàº½àº™àºªàº³à»€àº¥àº±àº”!',
            statsTitle: 'ğŸ“Š àºàº°àº”àº²àº™àºªàº°àº–àº´àº•àº´',
            statTotal: 'àºˆàº³àº™àº§àº™à»àº®àº‡àº‡àº²àº™àº—àº±àº‡à»àº»àº”',
            statComplete: 'àº­àº±àº”àº•àº²à»€àº­àºàº°àºªàº²àº™àº„àº»àºš',
            statRecent: 'àº¥àº»àº‡àº—àº°àºšàº½àº™à»€àº”àº·àº­àº™àº™àºµà»‰',
            statsByBatch: 'àºˆàº³àº™àº§àº™à»àº®àº‡àº‡àº²àº™àº•àº²àº¡àº¥àº¸à»‰àº™',
            statsDocStatus: 'àºªàº°àº–àº²àº™àº°àºàº²àº™àºªàº»à»ˆàº‡à»€àº­àºàº°àºªàº²àº™',
            detailTitle: 'àº¥àº²àºàº¥àº°àº­àº½àº”à»àº®àº‡àº‡àº²àº™',
            detailBasic: 'ğŸ“‹ àº‚à»à»‰àº¡àº¹àº™àºàº·à»‰àº™àº–àº²àº™',
            detailPeriod: 'ğŸ“… àº¥àº¸à»‰àº™ à»àº¥àº° àº§àº±àº™àº—àºµ',
            detailDocs: 'âœ… àº¥àº²àºàºàº²àº™àºàº§àº”',
            detailFiles: 'ğŸ“ à»€àº­àºàº°àºªàº²àº™',
            detailPeriodLabel: 'àº¥àº¸à»‰àº™',
            detailNotRegistered: '(àºšà»à»ˆàº—àº±àº™àº¥àº»àº‡àº—àº°àºšàº½àº™)',
            btnEdit: 'âœï¸ à»àºà»‰à»„àº‚',
            btnPrint: 'ğŸ–¨ï¸ àºàº´àº¡',
            btnDelete: 'ğŸ—‘ï¸ àº¥àº¶àºš',
            editTitle: 'à»àºà»‰à»„àº‚',
            btnSave: 'ğŸ’¾ àºšàº±àº™àº—àº¶àº',
            confirmDelete: 'àº—à»ˆàº²àº™à»àº™à»ˆà»ƒàºˆàºšà»à»ˆàº§à»ˆàº²àº•à»‰àº­àº‡àºàº²àº™àº¥àº¶àºš?',
            confirmBulkDelete: ' àº¥àº²àºàºàº²àº™àºˆàº°àº–àº·àºàº¥àº¶àºš. àºªàº·àºšàº•à»à»ˆàºšà»à»ˆ?',
            alertSelectItems: 'àºàº°àº¥àº¸àº™àº²à»€àº¥àº·àº­àºàº¥àº²àºàºàº²àº™àº—àºµà»ˆàº•à»‰àº­àº‡àºàº²àº™àº¥àº¶àºš',
            errorOccurred: 'à»€àºàºµàº”àº‚à»à»‰àºœàº´àº”àºàº²àº”: '
        }
    };
    
    let currentLang = 'ja';
    
    window.setLang = function(lang) {
    currentLang = lang;
    localStorage.setItem('language', lang);
    
    if (lang === 'lo') {
        document.body.style.fontFamily = "'Noto Sans Lao', 'Segoe UI', sans-serif";
    } else {
        document.body.style.fontFamily = "'Segoe UI', sans-serif";
    }
    
    updateUI();
};
    
    function updateUI() {
    const t = translations[currentLang];
    
    // ãƒ†ã‚­ã‚¹ãƒˆç¿»è¨³
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (t[key]) {
            el.textContent = t[key];
        }
    });
        
        // ãƒ†ã‚­ã‚¹ãƒˆç¿»è¨³
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (t[key]) {
            el.textContent = t[key];
        }
    });
    
    // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ç¿»è¨³
    document.querySelectorAll('[data-placeholder]').forEach(el => {
        const key = el.getAttribute('data-placeholder');
        if (t[key]) {
            el.placeholder = t[key];
        }
    });
    
    // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®æœ€åˆã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ç¿»è¨³
    document.querySelectorAll('[data-first-option]').forEach(el => {
        const key = el.getAttribute('data-first-option');
        if (t[key] && el.options[0]) {
            el.options[0].text = t[key];
        }
    });
    
    // æ›¸é¡çŠ¶æ³ã‚»ãƒ¬ã‚¯ãƒˆ
    const docsSelect = document.getElementById('adv-docs');
    if (docsSelect && docsSelect.options) {
        if (docsSelect.options[0]) docsSelect.options[0].text = t.searchDocs;
        if (docsSelect.options[1]) docsSelect.options[1].text = t.searchDocsComplete;
        if (docsSelect.options[2]) docsSelect.options[2].text = t.searchDocsIncomplete;
    }
    
    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã‚’å†ç”Ÿæˆ
    if (all.length > 0) {
        filters();
    }
}
    
    const savedLang = localStorage.getItem('language');
    if (savedLang && translations[savedLang]) {
        currentLang = savedLang;
        updateUI();
    }
    let all = [], filtered = [], flt = 'all', eid = null;
    
    document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', function() {
        const n = this.getAttribute('data-tab');
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        this.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
        document.getElementById(n + '-tab').classList.add('active');
        if (n === 'list') load();
    if (n === 'stats') loadStats();
    }));
    
    document.getElementById('search-input').addEventListener('input', search);
    document.getElementById('search-btn').addEventListener('click', search);
    document.getElementById('close-detail').addEventListener('click', () => close('detail-modal'));
    document.getElementById('close-edit').addEventListener('click', () => close('edit-modal'));
    document.getElementById('detail-modal').addEventListener('click', e => { if (e.target.id === 'detail-modal') close('detail-modal'); });
    document.getElementById('edit-modal').addEventListener('click', e => { if (e.target.id === 'edit-modal') close('edit-modal'); });
    document.getElementById('Worker-form').addEventListener('submit', add);
    document.getElementById('edit-form').addEventListener('submit', update);
    
    async function load() {
        const {data, error} = await sb.from('workers').select('*').order('created_at', {ascending: false});
        if (error) { console.error(error); return; }
        all = data || [];
        filters();
        show(all);
        populateBatch();
    }
    
    function filters() {
    const batches = [...new Set(all.map(s => s.batch).filter(x => x))];
    const c = document.getElementById('batch-filters');
    c.innerHTML = '';
    const a = document.createElement('button');
    a.className = 'filter-btn' + (flt === 'all' ? ' active' : '');
    const allText = {ja: 'å…¨ã¦', en: 'All', lo: 'àº—àº±àº‡à»àº»àº”'};
    a.textContent = allText[currentLang] || 'å…¨ã¦';
    a.onclick = () => filter('all');
    c.appendChild(a);
    batches.forEach(x => {
        const btn = document.createElement('button');
        btn.className = 'filter-btn' + (flt === x ? ' active' : '');
        btn.textContent = x;
        btn.onclick = () => filter(x);
        c.appendChild(btn);
    });
}
    
    function filter(b) {
        flt = b;
        filters();
        show(b === 'all' ? all : all.filter(s => s.batch === b));
    }
    
    function search() {
        const q = document.getElementById('search-input').value.toLowerCase();
        let f = flt === 'all' ? all : all.filter(s => s.batch === flt);
        if (q) f = f.filter(s => s.name?.toLowerCase().includes(q) || s.passport_number?.toLowerCase().includes(q));
        show(f);
    }
    
    function show(d) {
        const c = document.getElementById('Worker-list'), n = document.getElementById('no-results');
        if (d.length === 0) { c.style.display = 'none'; n.style.display = 'block'; return; }
        c.style.display = 'grid'; n.style.display = 'none';
        c.innerHTML = d.map(s => {
            const cnt = [s.has_passport, s.has_idcard, s.has_health_check, s.has_contract, s.has_visa, s.has_insurance].filter(Boolean).length;
            const isSelected = selected.includes(s.id);
return `<div class="Worker-card ${isSelected ? 'selected' : ''}" onclick="${selectMode ? `toggleSelect(${s.id}, event)` : `detail(${s.id})`}">
    ${selectMode ? `<input type="checkbox" class="Worker-checkbox" ${isSelected ? 'checked' : ''} onclick="toggleSelect(${s.id}, event)">` : ''}
                ${s.photo_url ? `<img src="${s.photo_url}" class="Worker-photo">` : `<div class="Worker-photo" style="display:flex;align-items:center;justify-content:center;font-size:3em;">ğŸ‘¤</div>`}
                <div class="Worker-name">${s.name || 'æœªç™»éŒ²'}</div>
                <div class="Worker-info">${s.batch ? `ğŸ“š ${s.batch}<br>` : ''}${s.passport_number ? `ğŸ›‚ ${s.passport_number}<br>` : ''}${currentLang === 'en' ? 'ğŸ“‹ Docs' : currentLang === 'lo' ? 'ğŸ“‹ à»€àº­àºàº°àºªàº²àº™' : 'ğŸ“‹ æ›¸é¡'}: ${cnt}/6</div>
            </div>`;
        }).join('');
    }
    
    window.detail = function(id) {
        const s = all.find(x => x.id === id);
        if (!s) return;
        document.getElementById('detail-content').innerHTML = `
            ${s.photo_url ? `<img src="${s.photo_url}" style="width:250px;height:300px;object-fit:cover;border-radius:12px;margin:0 auto 20px;display:block;">` : `<div style="width:250px;height:300px;background:#f0f0f0;border-radius:12px;margin:0 auto 20px;display:flex;align-items:center;justify-content:center;font-size:5em;">ğŸ‘¤</div>`}
            <div class="detail-section"><h3>ğŸ“‹ åŸºæœ¬æƒ…å ±</h3>
                ${row('åå‰', s.name)}${row('ç”Ÿå¹´æœˆæ—¥', s.birth_date)}${row('æ€§åˆ¥', s.gender)}${row('å›½ç±', s.nationality)}${row('ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ', s.passport_number)}${row('é›»è©±', s.phone_number)}
            </div>
            <div class="detail-section"><h3>ğŸ“… æœŸãƒ»æ—¥ä»˜</h3>
                ${row('æœŸ', s.batch)}${row('é¢æ¥æ—¥', s.interview_date)}${row('KITé–‹å§‹', s.kit_start_date)}${row('å¥‘ç´„é–‹å§‹', s.contract_start)}${row('å¥‘ç´„çµ‚äº†', s.contract_end)}
            </div>
            <div class="detail-section"><h3>âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h3>
                ${chk('ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ', s.has_passport)}${chk('IDã‚«ãƒ¼ãƒ‰', s.has_idcard)}${chk('å¥åº·è¨ºæ–­æ›¸', s.has_health_check)}${chk('åŠ´åƒå¥‘ç´„æ›¸', s.has_contract)}${chk('ãƒ“ã‚¶', s.has_visa)}${chk('ä¿é™ºè¨¼', s.has_insurance)}
            </div>
            <div class="detail-section"><h3>ğŸ“ æ›¸é¡</h3>
                ${link('ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ', s.passport_pdf_url)}${link('IDã‚«ãƒ¼ãƒ‰', s.idcard_pdf_url)}${link('å¥åº·è¨ºæ–­æ›¸', s.health_check_pdf_url)}
            </div>
            <div class="action-buttons">
                <button class="btn" onclick="edit(${s.id})">âœï¸ ç·¨é›†</button>
                <button class="btn btn-danger" onclick="del(${s.id})">ğŸ—‘ï¸ å‰Šé™¤</button>
            </div>`;
        document.getElementById('detail-modal').classList.add('active');
    };
    
    function row(l, v) { return v ? `<div class="detail-row"><div class="detail-label">${l}:</div><div>${v}</div></div>` : ''; }
    function chk(l, c) { return `<div class="checklist-item ${c ? 'complete' : 'incomplete'}"><span>${c ? 'âœ…' : 'âŒ'}</span><span>${l}</span></div>`; }
    function link(l, u) { return u ? `<a href="${u}" target="_blank" class="pdf-link">ğŸ“„ ${l}</a>` : `<div class="pdf-link empty">âŒ ${l} (æœªç™»éŒ²)</div>`; }
    
    window.edit = function(id) {
        eid = id;
        const s = all.find(x => x.id === id);
        document.getElementById('edit-form').innerHTML = `
            <div class="form-row">
                <div class="form-group"><label>åå‰</label><input name="name" value="${s.name || ''}"></div>
                <div class="form-group"><label>ç”Ÿå¹´æœˆæ—¥</label><input type="date" name="birth_date" value="${s.birth_date || ''}"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>æ€§åˆ¥</label><select name="gender"><option value="">é¸æŠ</option><option value="ç”·æ€§" ${s.gender === 'ç”·æ€§' ? 'selected' : ''}>ç”·æ€§</option><option value="å¥³æ€§" ${s.gender === 'å¥³æ€§' ? 'selected' : ''}>å¥³æ€§</option></select></div>
                <div class="form-group"><label>å›½ç±</label><input name="nationality" value="${s.nationality || ''}"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ</label><input name="passport_number" value="${s.passport_number || ''}"></div>
                <div class="form-group"><label>é›»è©±</label><input name="phone_number" value="${s.phone_number || ''}"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>æœŸ</label><input name="batch" value="${s.batch || ''}"></div>
                <div class="form-group"><label>é¢æ¥æ—¥</label><input type="date" name="interview_date" value="${s.interview_date || ''}"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>KITé–‹å§‹</label><input type="date" name="kit_start_date" value="${s.kit_start_date || ''}"></div>
                <div class="form-group"><label>å¥‘ç´„é–‹å§‹</label><input type="date" name="contract_start" value="${s.contract_start || ''}"></div>
            </div>
            <div class="form-group"><label>å¥‘ç´„çµ‚äº†</label><input type="date" name="contract_end" value="${s.contract_end || ''}"></div>
            <h3 style="margin:20px 0;">ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h3>
            <div class="checkbox-group">
                <div class="checkbox-item"><input type="checkbox" name="has_passport" ${s.has_passport ? 'checked' : ''}><label>ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ</label></div>
                <div class="checkbox-item"><input type="checkbox" name="has_idcard" ${s.has_idcard ? 'checked' : ''}><label>IDã‚«ãƒ¼ãƒ‰</label></div>
                <div class="checkbox-item"><input type="checkbox" name="has_health_check" ${s.has_health_check ? 'checked' : ''}><label>å¥åº·è¨ºæ–­æ›¸</label></div>
                <div class="checkbox-item"><input type="checkbox" name="has_contract" ${s.has_contract ? 'checked' : ''}><label>åŠ´åƒå¥‘ç´„æ›¸</label></div>
                <div class="checkbox-item"><input type="checkbox" name="has_visa" ${s.has_visa ? 'checked' : ''}><label>ãƒ“ã‚¶</label></div>
                <div class="checkbox-item"><input type="checkbox" name="has_insurance" ${s.has_insurance ? 'checked' : ''}><label>ä¿é™ºè¨¼</label></div>
            </div>
            <h3 style="margin:20px 0;">URL</h3>
            <div class="form-group"><label>é¡”å†™çœŸ</label><input type="url" name="photo_url" value="${s.photo_url || ''}"></div>
            <div class="form-group"><label>ãƒ‘ã‚¹ãƒãƒ¼ãƒˆPDF</label><input type="url" name="passport_pdf_url" value="${s.passport_pdf_url || ''}"></div>
            <div class="form-group"><label>IDã‚«ãƒ¼ãƒ‰PDF</label><input type="url" name="idcard_pdf_url" value="${s.idcard_pdf_url || ''}"></div>
            <div class="form-group"><label>å¥åº·è¨ºæ–­æ›¸PDF</label><input type="url" name="health_check_pdf_url" value="${s.health_check_pdf_url || ''}"></div>
            <button type="submit" class="btn" style="width:100%;margin-top:20px;">ğŸ’¾ ä¿å­˜</button>`;
        document.getElementById('edit-modal').classList.add('active');
    };
    
    window.del = async function(id) {
        if (!confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
        const {error} = await sb.from('workers').delete().eq('id', id);
        if (error) { alert('ã‚¨ãƒ©ãƒ¼: ' + error.message); return; }
        close('detail-modal');
        load();
    };
    
    function close(m) { document.getElementById(m).classList.remove('active'); }
    
    async function add(e) {
        e.preventDefault();
        const f = new FormData(e.target), d = {};
        for (let [k, v] of f.entries()) d[k] = v || null;
        d.has_passport = !!f.get('has_passport');
        d.has_idcard = !!f.get('has_idcard');
        d.has_health_check = !!f.get('has_health_check');
        d.has_contract = !!f.get('has_contract');
        d.has_visa = !!f.get('has_visa');
        d.has_insurance = !!f.get('has_insurance');
        const {error} = await sb.from('workers').insert([d]);
        if (error) { alert('ã‚¨ãƒ©ãƒ¼: ' + error.message); return; }
        document.getElementById('success-message').classList.add('show');
        e.target.reset();
        setTimeout(() => document.getElementById('success-message').classList.remove('show'), 3000);
        load();
    }
    
    async function update(e) {
        e.preventDefault();
        const f = new FormData(e.target), d = {};
        for (let [k, v] of f.entries()) d[k] = v || null;
        d.has_passport = !!f.get('has_passport');
        d.has_idcard = !!f.get('has_idcard');
        d.has_health_check = !!f.get('has_health_check');
        d.has_contract = !!f.get('has_contract');
        d.has_visa = !!f.get('has_visa');
        d.has_insurance = !!f.get('has_insurance');
        const {error} = await sb.from('workers').update(d).eq('id', eid);
        if (error) { alert('ã‚¨ãƒ©ãƒ¼: ' + error.message); return; }
        close('edit-modal');
        close('detail-modal');
        load();
    }
    window.exportExcel = function() {
        const data = filtered.length ? filtered : all;
        if (data.length === 0) { alert('ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
        
        let csv = 'ID,åå‰,ç”Ÿå¹´æœˆæ—¥,æ€§åˆ¥,å›½ç±,ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ,é›»è©±,æœŸ,é¢æ¥æ—¥,KITé–‹å§‹,å¥‘ç´„é–‹å§‹,å¥‘ç´„çµ‚äº†,ãƒ‘ã‚¹ãƒãƒ¼ãƒˆæå‡º,IDæå‡º,å¥è¨ºæå‡º,å¥‘ç´„æå‡º,ãƒ“ã‚¶æå‡º,ä¿é™ºæå‡º\n';
        data.forEach(s => {
            csv += `${s.id},"${s.name||''}","${s.birth_date||''}","${s.gender||''}","${s.nationality||''}","${s.passport_number||''}","${s.phone_number||''}","${s.batch||''}","${s.interview_date||''}","${s.kit_start_date||''}","${s.contract_start||''}","${s.contract_end||''}",${s.has_passport?'â—‹':''},${s.has_idcard?'â—‹':''},${s.has_health_check?'â—‹':''},${s.has_contract?'â—‹':''},${s.has_visa?'â—‹':''},${s.has_insurance?'â—‹':''}\n`;
        });
        
        const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
        const blob = new Blob([bom, csv], {type: 'text/csv;charset=utf-8;'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'éŸ“å›½åŠ´åƒè€…ä¸€è¦§_' + new Date().toISOString().split('T')[0] + '.csv';
        link.click();
    };
    
    window.exportCSV = function() {
        exportExcel();
    };

    window.advSearch = function() {
        const name = document.getElementById('adv-name').value.toLowerCase();
        const passport = document.getElementById('adv-passport').value.toLowerCase();
        const batch = document.getElementById('adv-batch').value;
        const dateFrom = document.getElementById('adv-date-from').value;
        const dateTo = document.getElementById('adv-date-to').value;
        const docs = document.getElementById('adv-docs').value;
        
        filtered = all.filter(s => {
            if (name && !s.name?.toLowerCase().includes(name)) return false;
            if (passport && !s.passport_number?.toLowerCase().includes(passport)) return false;
            if (batch && s.batch !== batch) return false;
            if (dateFrom && s.contract_start && s.contract_start < dateFrom) return false;
            if (dateTo && s.contract_start && s.contract_start > dateTo) return false;
            if (docs === 'complete') {
                const cnt = [s.has_passport, s.has_idcard, s.has_health_check, s.has_contract, s.has_visa, s.has_insurance].filter(Boolean).length;
                if (cnt < 6) return false;
            }
            if (docs === 'incomplete') {
                const cnt = [s.has_passport, s.has_idcard, s.has_health_check, s.has_contract, s.has_visa, s.has_insurance].filter(Boolean).length;
                if (cnt === 6) return false;
            }
            return true;
        });
        show(filtered);
    };
    
    window.clearAdv = function() {
        document.getElementById('adv-name').value = '';
        document.getElementById('adv-passport').value = '';
        document.getElementById('adv-batch').value = '';
        document.getElementById('adv-date-from').value = '';
        document.getElementById('adv-date-to').value = '';
        document.getElementById('adv-docs').value = '';
        filtered = [];
        show(all);
    };
    
    function populateBatch() {
        const batches = [...new Set(all.map(s => s.batch).filter(x => x))];
        const sel = document.getElementById('adv-batch');
        if (!sel) return;
        sel.innerHTML = '<option value="">å…¨æœŸç”Ÿ</option>';
        batches.forEach(b => {
            const opt = document.createElement('option');
            opt.value = b;
            opt.textContent = b;
            sel.appendChild(opt);
        });
    }

     let selectMode = false;
    let selected = [];
    
    window.toggleSelectMode = function() {
        selectMode = document.getElementById('select-mode').checked;
        selected = [];
        document.getElementById('bulk-delete-btn').style.display = selectMode ? 'inline-block' : 'none';
        show(filtered.length ? filtered : all);
    };
    
    window.toggleSelect = function(id, event) {
        event.stopPropagation();
        const idx = selected.indexOf(id);
        if (idx > -1) {
            selected.splice(idx, 1);
        } else {
            selected.push(id);
        }
        show(filtered.length ? filtered : all);
    };
    
    window.bulkDelete = async function() {
        if (selected.length === 0) {
            alert('å‰Šé™¤ã™ã‚‹é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„');
            return;
        }
        if (!confirm(`${selected.length}ä»¶ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
        
        const {error} = await sb.from('workers').delete().in('id', selected);
        if (error) {
            alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
            return;
        }
        selected = [];
        selectMode = false;
        document.getElementById('select-mode').checked = false;
        document.getElementById('bulk-delete-btn').style.display = 'none';
        load();
    };

    window.loadStats = function() {
        if (all.length === 0) return;
        
        // ç·åŠ´åƒè€…æ•°
        document.getElementById('stat-total').textContent = all.length;
        
        // æ›¸é¡å®Œäº†ç‡
        const complete = all.filter(s => {
            const cnt = [s.has_passport, s.has_idcard, s.has_health_check, s.has_contract, s.has_visa, s.has_insurance].filter(Boolean).length;
            return cnt === 6;
        }).length;
        const rate = all.length > 0 ? Math.round((complete / all.length) * 100) : 0;
        document.getElementById('stat-complete').textContent = rate + '%';
        
        // ä»Šæœˆã®ç™»éŒ²
        const thisMonth = new Date().toISOString().slice(0, 7);
        const recent = all.filter(s => s.created_at && s.created_at.startsWith(thisMonth)).length;
        document.getElementById('stat-recent').textContent = recent;
        
        // æœŸåˆ¥åŠ´åƒè€…æ•°ã‚°ãƒ©ãƒ•
        const batchData = {};
        all.forEach(s => {
            if (s.batch) {
                batchData[s.batch] = (batchData[s.batch] || 0) + 1;
            }
        });
        const batchChart = document.getElementById('batch-chart');
        batchChart.innerHTML = Object.entries(batchData).map(([batch, count]) => {
            const percent = (count / all.length) * 100;
            return `<div style="margin-bottom:10px;">
                <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
                    <span>${batch}</span>
                    <span>${count}äºº (${Math.round(percent)}%)</span>
                </div>
                <div style="background:#e0e0e0;border-radius:10px;height:30px;overflow:hidden;">
                    <div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);height:100%;width:${percent}%;border-radius:10px;display:flex;align-items:center;justify-content:center;color:white;font-weight:600;">
                        ${count}äºº
                    </div>
                </div>
            </div>`;
        }).join('');
        
        // æ›¸é¡æå‡ºçŠ¶æ³
        const docs = {
            'ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ': all.filter(s => s.has_passport).length,
            'IDã‚«ãƒ¼ãƒ‰': all.filter(s => s.has_idcard).length,
            'å¥åº·è¨ºæ–­æ›¸': all.filter(s => s.has_health_check).length,
            'åŠ´åƒå¥‘ç´„æ›¸': all.filter(s => s.has_contract).length,
            'ãƒ“ã‚¶': all.filter(s => s.has_visa).length,
            'ä¿é™ºè¨¼': all.filter(s => s.has_insurance).length
        };
        const docsChart = document.getElementById('docs-chart');
        docsChart.innerHTML = Object.entries(docs).map(([doc, count]) => {
            const percent = all.length > 0 ? (count / all.length) * 100 : 0;
            return `<div style="margin-bottom:10px;">
                <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
                    <span>${doc}</span>
                    <span>${count}/${all.length}äºº (${Math.round(percent)}%)</span>
                </div>
                <div style="background:#e0e0e0;border-radius:10px;height:30px;overflow:hidden;">
                    <div style="background:linear-gradient(135deg,#4caf50 0%,#66bb6a 100%);height:100%;width:${percent}%;border-radius:10px;display:flex;align-items:center;justify-content:center;color:white;font-weight:600;">
                        ${Math.round(percent)}%
                    </div>
                </div>
            </div>`;
        }).join('');
    };
    document.getElementById('lang-ja').addEventListener('click', () => setLang('ja'));
    document.getElementById('lang-en').addEventListener('click', () => setLang('en'));
    document.getElementById('lang-lo').addEventListener('click', () => setLang('lo'));
    
    load();
    }
});
    </script>
</body>
</html>
