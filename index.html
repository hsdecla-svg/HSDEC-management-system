<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HSDEC Staff Management System</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; border-radius: 20px 20px 0 0; }
        h1 { font-size: 2.5em; margin-bottom: 10px; }
        .tabs { display: flex; background: #f5f5f5; border-bottom: 2px solid #ddd; }
        .tab { flex: 1; padding: 20px; text-align: center; cursor: pointer; font-size: 1.1em; font-weight: 600; transition: all 0.3s; border: none; background: none; }
        .tab:hover { background: #e0e0e0; }
        .tab.active { background: white; color: #667eea; border-bottom: 3px solid #667eea; }
        .content { padding: 30px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        input, select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em; }
        input:focus, select:focus { outline: none; border-color: #667eea; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 40px; border: none; border-radius: 8px; font-size: 1.1em; font-weight: 600; cursor: pointer; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .btn-danger { background: linear-gradient(135deg, #f44336 0%, #e91e63 100%); }
        .search-box { display: flex; gap: 10px; margin-bottom: 30px; }
        .search-box input { flex: 1; }
        .staff-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .staff-card { border: 2px solid #ddd; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s; }
        .staff-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-color: #667eea; }
        .staff-photo { width: 100%; height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 15px; background: #f0f0f0; }
        .staff-name { font-size: 1.3em; font-weight: 600; margin-bottom: 10px; }
        .staff-info { color: #666; line-height: 1.6; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; }
        .modal.active { display: flex; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; border-radius: 20px; padding: 40px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #ddd; }
        .close-btn { background: none; border: none; font-size: 2em; cursor: pointer; color: #999; }
        .detail-section { margin-bottom: 30px; }
        .detail-section h3 { color: #667eea; margin-bottom: 15px; font-size: 1.3em; }
        .detail-row { display: grid; grid-template-columns: 150px 1fr; gap: 10px; margin-bottom: 10px; padding: 10px; background: #f9f9f9; border-radius: 8px; }
        .detail-label { font-weight: 600; }
        .pdf-link { display: block; padding: 15px; background: #f0f0f0; border-radius: 8px; text-decoration: none; color: #333; margin-bottom: 10px; }
        .pdf-link:hover { background: #667eea; color: white; }
        .pdf-link.empty { opacity: 0.5; pointer-events: none; }
        .success-message { background: #4caf50; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .success-message.show { display: block; }
        .filter-btn { padding: 10px 20px; background: #f0f0f0; border: 2px solid #ddd; border-radius: 20px; cursor: pointer; margin: 0 5px 10px 0; }
        .filter-btn.active { background: #667eea; color: white; border-color: #667eea; }
        .checkbox-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px; }
        .checkbox-item { display: flex; align-items: center; gap: 10px; padding: 12px; background: #f9f9f9; border-radius: 8px; }
        .checkbox-item input { width: 20px; height: 20px; }
        .checklist-item { display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: #f9f9f9; border-radius: 6px; margin-bottom: 8px; }
        .checklist-item.complete { background: #e8f5e9; }
        .checklist-item.incomplete { background: #ffebee; }
        .action-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .action-buttons .btn { flex: 1; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ¢ HSDEC Staff Management</h1>
            <p>ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </p>
        </header>
        
        <div class="tabs">
            <button class="tab active" data-tab="list">ğŸ“‹ ã‚¹ã‚¿ãƒƒãƒ•ä¸€è¦§</button>
            <button class="tab" data-tab="add">â• æ–°è¦ç™»éŒ²</button>
        </div>
        
        <div class="content">
            <div id="list-tab" class="tab-content active">
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="ğŸ” åå‰ã§æ¤œç´¢...">
                    <button class="btn" id="search-btn">æ¤œç´¢</button>
                </div>
                <div id="batch-filters" style="margin-bottom:20px;"></div>
                <div id="staff-list" class="staff-grid"></div>
                <div id="no-results" style="display:none;text-align:center;padding:40px;color:#999;">è©²å½“ãªã—</div>
            </div>

            <div style="margin-bottom:20px;">
                <button class="btn btn-success btn-small" onclick="exportExcel()">ğŸ“¥ Excelå‡ºåŠ›</button>
                <button class="btn btn-success btn-small" onclick="exportCSV()">ğŸ“„ CSVå‡ºåŠ›</button>
            </div>
            
            <div id="add-tab" class="tab-content">
                <div class="success-message" id="success-message">âœ… ç™»éŒ²å®Œäº†ï¼</div>
                <form id="staff-form">
                    <h2 style="margin-bottom:30px;">åŸºæœ¬æƒ…å ±</h2>
                    <div class="form-row">
                        <div class="form-group"><label>åå‰ *</label><input type="text" name="name" required></div>
                        <div class="form-group"><label>ç”Ÿå¹´æœˆæ—¥</label><input type="date" name="birth_date"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>æ€§åˆ¥</label><select name="gender"><option value="">é¸æŠ</option><option value="ç”·æ€§">ç”·æ€§</option><option value="å¥³æ€§">å¥³æ€§</option></select></div>
                        <div class="form-group"><label>å›½ç±</label><input type="text" name="nationality" value="Laos"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>ãƒ‘ã‚¹ãƒãƒ¼ãƒˆç•ªå·</label><input type="text" name="passport_number"></div>
                        <div class="form-group"><label>é›»è©±ç•ªå·</label><input type="text" name="phone_number"></div>
                    </div>
                    <h2 style="margin:40px 0 30px;">æœŸãƒ»æ—¥ä»˜æƒ…å ±</h2>
                    <div class="form-row">
                        <div class="form-group"><label>ç¬¬â—‹æœŸç”Ÿ</label><input type="text" name="batch" placeholder="ä¾‹:ç¬¬3æœŸç”Ÿ"></div>
                        <div class="form-group"><label>é¢æ¥æ—¥</label><input type="date" name="interview_date"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>KITå‹‰å¼·é–‹å§‹æ—¥</label><input type="date" name="kit_start_date"></div>
                        <div class="form-group"><label>å¥‘ç´„é–‹å§‹æ—¥</label><input type="date" name="contract_start"></div>
                    </div>
                    <div class="form-group"><label>å¥‘ç´„çµ‚äº†æ—¥</label><input type="date" name="contract_end"></div>
                    <h2 style="margin:40px 0 20px;">ğŸ“‹ æ›¸é¡ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h2>
                    <div class="checkbox-group">
                        <div class="checkbox-item"><input type="checkbox" name="has_passport" id="p1"><label for="p1">ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ</label></div>
                        <div class="checkbox-item"><input type="checkbox" name="has_idcard" id="p2"><label for="p2">IDã‚«ãƒ¼ãƒ‰</label></div>
                        <div class="checkbox-item"><input type="checkbox" name="has_health_check" id="p3"><label for="p3">å¥åº·è¨ºæ–­æ›¸</label></div>
                        <div class="checkbox-item"><input type="checkbox" name="has_contract" id="p4"><label for="p4">åŠ´åƒå¥‘ç´„æ›¸</label></div>
                        <div class="checkbox-item"><input type="checkbox" name="has_visa" id="p5"><label for="p5">ãƒ“ã‚¶</label></div>
                        <div class="checkbox-item"><input type="checkbox" name="has_insurance" id="p6"><label for="p6">ä¿é™ºè¨¼</label></div>
                    </div>
                    <h2 style="margin:40px 0 30px;">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«URL</h2>
                    <div class="form-group"><label>é¡”å†™çœŸURL</label><input type="url" name="photo_url"></div>
                    <div class="form-group"><label>ãƒ‘ã‚¹ãƒãƒ¼ãƒˆPDF</label><input type="url" name="passport_pdf_url"></div>
                    <div class="form-group"><label>IDã‚«ãƒ¼ãƒ‰PDF</label><input type="url" name="idcard_pdf_url"></div>
                    <div class="form-group"><label>å¥åº·è¨ºæ–­æ›¸PDF</label><input type="url" name="health_check_pdf_url"></div>
                    <button type="submit" class="btn" style="margin-top:30px;width:100%;">âœ… ç™»éŒ²</button>
                </form>
            </div>
        </div>
    </div>
    
    <div id="detail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>ã‚¹ã‚¿ãƒƒãƒ•è©³ç´°</h2><button class="close-btn" id="close-detail">&times;</button></div>
            <div id="detail-content"></div>
        </div>
    </div>
    
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>ç·¨é›†</h2><button class="close-btn" id="close-edit">&times;</button></div>
            <form id="edit-form"></form>
        </div>
    </div>

    <script>
(function() {
    const sb = window.supabase.createClient('https://zgmqllufmqanixgwdjok.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpnbXFsbHVmbXFhbml4Z3dkam9rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczMzk0MjAsImV4cCI6MjA4MjkxNTQyMH0.xg-5T7DfcW2enMAXvudNOMPbvvm1WSwRHGZ_Vpdyrrw');
    let all = [], filtered = [], flt = 'all', eid = null;
    
    document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', function() {
        const n = this.getAttribute('data-tab');
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        this.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
        document.getElementById(n + '-tab').classList.add('active');
        if (n === 'list') load();
    }));
    
    document.getElementById('search-input').addEventListener('input', search);
    document.getElementById('search-btn').addEventListener('click', search);
    document.getElementById('close-detail').addEventListener('click', () => close('detail-modal'));
    document.getElementById('close-edit').addEventListener('click', () => close('edit-modal'));
    document.getElementById('detail-modal').addEventListener('click', e => { if (e.target.id === 'detail-modal') close('detail-modal'); });
    document.getElementById('edit-modal').addEventListener('click', e => { if (e.target.id === 'edit-modal') close('edit-modal'); });
    document.getElementById('staff-form').addEventListener('submit', add);
    document.getElementById('edit-form').addEventListener('submit', update);
    
    async function load() {
        const {data, error} = await sb.from('workers').select('*').order('created_at', {ascending: false});
        if (error) { console.error(error); return; }
        all = data || [];
        filters();
        show(all);
    }
    
    function filters() {
        const b = [...new Set(all.map(s => s.batch).filter(x => x))];
        const c = document.getElementById('batch-filters');
        c.innerHTML = '';
        const a = document.createElement('button');
        a.className = 'filter-btn' + (flt === 'all' ? ' active' : '');
        a.textContent = 'å…¨ã¦';
        a.onclick = () => filter('all');
        c.appendChild(a);
        b.forEach(x => {
            const btn = document.createElement('button');
            btn.className = 'filter-btn' + (flt === x ? ' active' : '');
            btn.textContent = x;
            btn.onclick = () => filter(x);
            c.appendChild(btn);
        });
    }
    
    function filter(b) {
        flt = b;
        filters();
        show(b === 'all' ? all : all.filter(s => s.batch === b));
    }
    
    function search() {
        const q = document.getElementById('search-input').value.toLowerCase();
        let f = flt === 'all' ? all : all.filter(s => s.batch === flt);
        if (q) f = f.filter(s => s.name?.toLowerCase().includes(q) || s.passport_number?.toLowerCase().includes(q));
        show(f);
    }
    
    function show(d) {
        const c = document.getElementById('staff-list'), n = document.getElementById('no-results');
        if (d.length === 0) { c.style.display = 'none'; n.style.display = 'block'; return; }
        c.style.display = 'grid'; n.style.display = 'none';
        c.innerHTML = d.map(s => {
            const cnt = [s.has_passport, s.has_idcard, s.has_health_check, s.has_contract, s.has_visa, s.has_insurance].filter(Boolean).length;
            return `<div class="staff-card" onclick="detail(${s.id})">
                ${s.photo_url ? `<img src="${s.photo_url}" class="staff-photo">` : `<div class="staff-photo" style="display:flex;align-items:center;justify-content:center;font-size:3em;">ğŸ‘¤</div>`}
                <div class="staff-name">${s.name || 'æœªç™»éŒ²'}</div>
                <div class="staff-info">${s.batch ? `ğŸ“š ${s.batch}<br>` : ''}${s.passport_number ? `ğŸ›‚ ${s.passport_number}<br>` : ''}ğŸ“‹ æ›¸é¡: ${cnt}/6</div>
            </div>`;
        }).join('');
    }
    
    window.detail = function(id) {
        const s = all.find(x => x.id === id);
        if (!s) return;
        document.getElementById('detail-content').innerHTML = `
            ${s.photo_url ? `<img src="${s.photo_url}" style="width:250px;height:300px;object-fit:cover;border-radius:12px;margin:0 auto 20px;display:block;">` : `<div style="width:250px;height:300px;background:#f0f0f0;border-radius:12px;margin:0 auto 20px;display:flex;align-items:center;justify-content:center;font-size:5em;">ğŸ‘¤</div>`}
            <div class="detail-section"><h3>ğŸ“‹ åŸºæœ¬æƒ…å ±</h3>
                ${row('åå‰', s.name)}${row('ç”Ÿå¹´æœˆæ—¥', s.birth_date)}${row('æ€§åˆ¥', s.gender)}${row('å›½ç±', s.nationality)}${row('ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ', s.passport_number)}${row('é›»è©±', s.phone_number)}
            </div>
            <div class="detail-section"><h3>ğŸ“… æœŸãƒ»æ—¥ä»˜</h3>
                ${row('æœŸ', s.batch)}${row('é¢æ¥æ—¥', s.interview_date)}${row('KITé–‹å§‹', s.kit_start_date)}${row('å¥‘ç´„é–‹å§‹', s.contract_start)}${row('å¥‘ç´„çµ‚äº†', s.contract_end)}
            </div>
            <div class="detail-section"><h3>âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h3>
                ${chk('ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ', s.has_passport)}${chk('IDã‚«ãƒ¼ãƒ‰', s.has_idcard)}${chk('å¥åº·è¨ºæ–­æ›¸', s.has_health_check)}${chk('åŠ´åƒå¥‘ç´„æ›¸', s.has_contract)}${chk('ãƒ“ã‚¶', s.has_visa)}${chk('ä¿é™ºè¨¼', s.has_insurance)}
            </div>
            <div class="detail-section"><h3>ğŸ“ æ›¸é¡</h3>
                ${link('ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ', s.passport_pdf_url)}${link('IDã‚«ãƒ¼ãƒ‰', s.idcard_pdf_url)}${link('å¥åº·è¨ºæ–­æ›¸', s.health_check_pdf_url)}
            </div>
            <div class="action-buttons">
                <button class="btn" onclick="edit(${s.id})">âœï¸ ç·¨é›†</button>
                <button class="btn btn-danger" onclick="del(${s.id})">ğŸ—‘ï¸ å‰Šé™¤</button>
            </div>`;
        document.getElementById('detail-modal').classList.add('active');
    };
    
    function row(l, v) { return v ? `<div class="detail-row"><div class="detail-label">${l}:</div><div>${v}</div></div>` : ''; }
    function chk(l, c) { return `<div class="checklist-item ${c ? 'complete' : 'incomplete'}"><span>${c ? 'âœ…' : 'âŒ'}</span><span>${l}</span></div>`; }
    function link(l, u) { return u ? `<a href="${u}" target="_blank" class="pdf-link">ğŸ“„ ${l}</a>` : `<div class="pdf-link empty">âŒ ${l} (æœªç™»éŒ²)</div>`; }
    
    window.edit = function(id) {
        eid = id;
        const s = all.find(x => x.id === id);
        document.getElementById('edit-form').innerHTML = `
            <div class="form-row">
                <div class="form-group"><label>åå‰</label><input name="name" value="${s.name || ''}"></div>
                <div class="form-group"><label>ç”Ÿå¹´æœˆæ—¥</label><input type="date" name="birth_date" value="${s.birth_date || ''}"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>æ€§åˆ¥</label><select name="gender"><option value="">é¸æŠ</option><option value="ç”·æ€§" ${s.gender === 'ç”·æ€§' ? 'selected' : ''}>ç”·æ€§</option><option value="å¥³æ€§" ${s.gender === 'å¥³æ€§' ? 'selected' : ''}>å¥³æ€§</option></select></div>
                <div class="form-group"><label>å›½ç±</label><input name="nationality" value="${s.nationality || ''}"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ</label><input name="passport_number" value="${s.passport_number || ''}"></div>
                <div class="form-group"><label>é›»è©±</label><input name="phone_number" value="${s.phone_number || ''}"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>æœŸ</label><input name="batch" value="${s.batch || ''}"></div>
                <div class="form-group"><label>é¢æ¥æ—¥</label><input type="date" name="interview_date" value="${s.interview_date || ''}"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>KITé–‹å§‹</label><input type="date" name="kit_start_date" value="${s.kit_start_date || ''}"></div>
                <div class="form-group"><label>å¥‘ç´„é–‹å§‹</label><input type="date" name="contract_start" value="${s.contract_start || ''}"></div>
            </div>
            <div class="form-group"><label>å¥‘ç´„çµ‚äº†</label><input type="date" name="contract_end" value="${s.contract_end || ''}"></div>
            <h3 style="margin:20px 0;">ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h3>
            <div class="checkbox-group">
                <div class="checkbox-item"><input type="checkbox" name="has_passport" ${s.has_passport ? 'checked' : ''}><label>ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ</label></div>
                <div class="checkbox-item"><input type="checkbox" name="has_idcard" ${s.has_idcard ? 'checked' : ''}><label>IDã‚«ãƒ¼ãƒ‰</label></div>
                <div class="checkbox-item"><input type="checkbox" name="has_health_check" ${s.has_health_check ? 'checked' : ''}><label>å¥åº·è¨ºæ–­æ›¸</label></div>
                <div class="checkbox-item"><input type="checkbox" name="has_contract" ${s.has_contract ? 'checked' : ''}><label>åŠ´åƒå¥‘ç´„æ›¸</label></div>
                <div class="checkbox-item"><input type="checkbox" name="has_visa" ${s.has_visa ? 'checked' : ''}><label>ãƒ“ã‚¶</label></div>
                <div class="checkbox-item"><input type="checkbox" name="has_insurance" ${s.has_insurance ? 'checked' : ''}><label>ä¿é™ºè¨¼</label></div>
            </div>
            <h3 style="margin:20px 0;">URL</h3>
            <div class="form-group"><label>é¡”å†™çœŸ</label><input type="url" name="photo_url" value="${s.photo_url || ''}"></div>
            <div class="form-group"><label>ãƒ‘ã‚¹ãƒãƒ¼ãƒˆPDF</label><input type="url" name="passport_pdf_url" value="${s.passport_pdf_url || ''}"></div>
            <div class="form-group"><label>IDã‚«ãƒ¼ãƒ‰PDF</label><input type="url" name="idcard_pdf_url" value="${s.idcard_pdf_url || ''}"></div>
            <div class="form-group"><label>å¥åº·è¨ºæ–­æ›¸PDF</label><input type="url" name="health_check_pdf_url" value="${s.health_check_pdf_url || ''}"></div>
            <button type="submit" class="btn" style="width:100%;margin-top:20px;">ğŸ’¾ ä¿å­˜</button>`;
        document.getElementById('edit-modal').classList.add('active');
    };
    
    window.del = async function(id) {
        if (!confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
        const {error} = await sb.from('workers').delete().eq('id', id);
        if (error) { alert('ã‚¨ãƒ©ãƒ¼: ' + error.message); return; }
        close('detail-modal');
        load();
    };
    
    function close(m) { document.getElementById(m).classList.remove('active'); }
    
    async function add(e) {
        e.preventDefault();
        const f = new FormData(e.target), d = {};
        for (let [k, v] of f.entries()) d[k] = v || null;
        d.has_passport = !!f.get('has_passport');
        d.has_idcard = !!f.get('has_idcard');
        d.has_health_check = !!f.get('has_health_check');
        d.has_contract = !!f.get('has_contract');
        d.has_visa = !!f.get('has_visa');
        d.has_insurance = !!f.get('has_insurance');
        const {error} = await sb.from('workers').insert([d]);
        if (error) { alert('ã‚¨ãƒ©ãƒ¼: ' + error.message); return; }
        document.getElementById('success-message').classList.add('show');
        e.target.reset();
        setTimeout(() => document.getElementById('success-message').classList.remove('show'), 3000);
        load();
    }
    
    async function update(e) {
        e.preventDefault();
        const f = new FormData(e.target), d = {};
        for (let [k, v] of f.entries()) d[k] = v || null;
        d.has_passport = !!f.get('has_passport');
        d.has_idcard = !!f.get('has_idcard');
        d.has_health_check = !!f.get('has_health_check');
        d.has_contract = !!f.get('has_contract');
        d.has_visa = !!f.get('has_visa');
        d.has_insurance = !!f.get('has_insurance');
        const {error} = await sb.from('workers').update(d).eq('id', eid);
        if (error) { alert('ã‚¨ãƒ©ãƒ¼: ' + error.message); return; }
        close('edit-modal');
        close('detail-modal');
        load();
    }
    window.exportExcel = function() {
        const data = filtered.length ? filtered : all;
        if (data.length === 0) { alert('ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
        
        let csv = 'ID,åå‰,ç”Ÿå¹´æœˆæ—¥,æ€§åˆ¥,å›½ç±,ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ,é›»è©±,æœŸ,é¢æ¥æ—¥,KITé–‹å§‹,å¥‘ç´„é–‹å§‹,å¥‘ç´„çµ‚äº†,ãƒ‘ã‚¹ãƒãƒ¼ãƒˆæå‡º,IDæå‡º,å¥è¨ºæå‡º,å¥‘ç´„æå‡º,ãƒ“ã‚¶æå‡º,ä¿é™ºæå‡º\n';
        data.forEach(s => {
            csv += `${s.id},"${s.name||''}","${s.birth_date||''}","${s.gender||''}","${s.nationality||''}","${s.passport_number||''}","${s.phone_number||''}","${s.batch||''}","${s.interview_date||''}","${s.kit_start_date||''}","${s.contract_start||''}","${s.contract_end||''}",${s.has_passport?'â—‹':''},${s.has_idcard?'â—‹':''},${s.has_health_check?'â—‹':''},${s.has_contract?'â—‹':''},${s.has_visa?'â—‹':''},${s.has_insurance?'â—‹':''}\n`;
        });
        
        const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
        const blob = new Blob([bom, csv], {type: 'text/csv;charset=utf-8;'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'ã‚¹ã‚¿ãƒƒãƒ•ä¸€è¦§_' + new Date().toISOString().split('T')[0] + '.csv';
        link.click();
    };
    
    window.exportCSV = function() {
        exportExcel();
    };
    
    load();
})();
    </script>
</body>
</html>
