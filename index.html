<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HSDEC Global Platform v3.0</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .form-input { border: 2px solid #e2e8f0; padding: 0.8rem; border-radius: 0.8rem; width: 100%; outline: none; transition: 0.2s; font-size: 14px; }
        .form-input:focus { border-color: #3b82f6; background-color: #fff; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }
        .label-text { font-size: 10px; font-weight: 900; color: #64748b; text-transform: uppercase; margin-bottom: 4px; display: block; margin-left: 4px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const SUPABASE_URL = 'https://zgmqllufmqanixgwdjok.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_vOgl-K0RTxyK9i0WJp7UwA_PlwVgESz';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('list'); // 'list' or 'edit'
            const [workers, setWorkers] = useState([]);
            const [loading, setLoading] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [activeTab, setActiveTab] = useState('basic');

            // 51é …ç›®ã®ãƒ™ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
            const initialForm = {
                id: null, name: '', phone: '', passport_no: '', gender: '', birth_date: '',
                docs_land_titles: false, docs_health_cert: false, docs_criminal_record: false,
                topik_level: '', total_score: 0, interview_score: 0,
                dispatch_status: 'Waiting', company_feedback: '', work_attitude_score: 0
            };
            const [formData, setFormData] = useState(initialForm);

            useEffect(() => {
                supabaseClient.auth.getSession().then(({ data: { session } }) => {
                    setUser(session?.user ?? null);
                    if (session) fetchWorkers();
                });
            }, []);

            const fetchWorkers = async () => {
                setLoading(true);
                const { data, error } = await supabaseClient.from('workers').select('*').order('created_at', { ascending: false });
                if (!error) setWorkers(data || []);
                setLoading(false);
            };

            const handleSave = async (e) => {
                e.preventDefault();
                setLoading(true);
                const { error } = await supabaseClient.from('workers').upsert([formData]);
                if (error) {
                    alert("ä¿å­˜ã‚¨ãƒ©ãƒ¼: " + error.message);
                } else {
                    alert("ä¿å­˜å®Œäº†ï¼");
                    setView('list');
                    fetchWorkers();
                }
                setLoading(false);
            };

            const startEdit = (worker) => {
                setFormData(worker);
                setView('edit');
                setActiveTab('basic');
            };

            const filteredWorkers = workers.filter(w => 
                w.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                w.passport_no?.toLowerCase().includes(searchTerm.toLowerCase())
            );

            if (!user) return <LoginForm supabase={supabaseClient} />;

            return (
                <div class="min-h-screen flex flex-col md:flex-row">
                    {/* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */}
                    <aside class="w-full md:w-64 bg-slate-900 text-white p-6 shadow-xl flex-shrink-0">
                        <div class="mb-10 text-2xl font-black text-blue-400 italic">HSDEC</div>
                        <nav class="space-y-4">
                            <button onClick={() => { setView('list'); fetchWorkers(); }} class={`w-full text-left p-3 rounded-xl font-bold transition ${view === 'list' ? 'bg-blue-600' : 'text-slate-400 hover:text-white'}`}>ğŸ“‚ åç°¿ä¸€è¦§</button>
                            <button onClick={() => { setFormData(initialForm); setView('edit'); setActiveTab('basic'); }} class={`w-full text-left p-3 rounded-xl font-bold transition ${view === 'edit' && !formData.id ? 'bg-blue-600' : 'text-slate-400 hover:text-white'}`}>â• æ–°è¦ç™»éŒ²</button>
                            <button onClick={() => supabaseClient.auth.signOut()} class="w-full text-left p-3 text-red-500 text-xs mt-20 font-black">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                        </nav>
                    </aside>

                    <main class="flex-grow p-6 md:p-10 overflow-auto">
                        {view === 'list' ? (
                            <div class="max-w-6xl mx-auto">
                                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-4">
                                    <h2 class="text-3xl font-black text-slate-800 tracking-tight">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
                                    <div class="flex gap-4 w-full md:w-auto">
                                        <input type="text" placeholder="åå‰ã‚„ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã§æ¤œç´¢..." class="form-input bg-white shadow-sm !w-64" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                                        <button onClick={fetchWorkers} class="bg-white border p-3 rounded-xl hover:bg-slate-50 transition shadow-sm">{loading ? '...' : 'ğŸ”„'}</button>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {filteredWorkers.map(w => (
                                        <div key={w.id} onClick={() => startEdit(w)} class="bg-white p-6 rounded-[2rem] shadow-sm border-2 border-transparent hover:border-blue-500 hover:shadow-xl transition-all cursor-pointer group relative overflow-hidden">
                                            <div class="absolute top-0 right-0 px-4 py-2 bg-slate-50 text-[9px] font-black text-slate-400 rounded-bl-xl group-hover:bg-blue-50 group-hover:text-blue-500">{w.dispatch_status}</div>
                                            <div class="font-black text-xl text-slate-800 mb-1">{w.name}</div>
                                            <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Passport: {w.passport_no || '---'}</div>
                                            <div class="flex gap-2 border-t pt-4">
                                                <span class="bg-blue-50 text-blue-600 text-[9px] font-black px-2 py-1 rounded">TOPIK {w.topik_level || '-'}</span>
                                                <span class="bg-amber-50 text-amber-600 text-[9px] font-black px-2 py-1 rounded">Score {w.total_score || '0'}</span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ) : (
                            /* ç·¨é›†ãƒ»ç™»éŒ²ç”»é¢ */
                            <div class="max-w-4xl mx-auto bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border border-slate-100">
                                <div class="flex bg-slate-50 border-b overflow-x-auto">
                                    {[
                                        { id: 'basic', label: '1. åŸºæœ¬æƒ…å ±' },
                                        { id: 'docs', label: '2. æ›¸é¡ç¢ºèª' },
                                        { id: 'interview', label: '3-4. é¸æŠœè©•ä¾¡' },
                                        { id: 'dispatch', label: '5-6. æ´¾é£ãƒ»ä¼æ¥­' }
                                    ].map(tab => (
                                        <button key={tab.id} onClick={() => setActiveTab(tab.id)} class={`px-8 py-5 text-[10px] font-black uppercase tracking-widest transition-all whitespace-nowrap ${activeTab === tab.id ? 'bg-white text-blue-600 border-b-4 border-blue-600' : 'text-slate-400 hover:text-slate-600'}`}>{tab.label}</button>
                                    ))}
                                </div>
                                
                                <form onSubmit={handleSave} class="p-8 md:p-12">
                                    {activeTab === 'basic' && (
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 animate-in fade-in">
                                            <div class="md:col-span-2"><label class="label-text">ãƒ•ãƒ«ãƒãƒ¼ãƒ </label><input type="text" class="form-input" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} required /></div>
                                            <div><label class="label-text">ãƒ‘ã‚¹ãƒãƒ¼ãƒˆç•ªå·</label><input type="text" class="form-input" value={formData.passport_no} onChange={e => setFormData({...formData, passport_no: e.target.value})} /></div>
                                            <div><label class="label-text">é›»è©±ç•ªå·</label><input type="text" class="form-input" value={formData.phone} onChange={e => setFormData({...formData, phone: e.target.value})} /></div>
                                            <div><label class="label-text">æ€§åˆ¥</label><select class="form-input" value={formData.gender} onChange={e => setFormData({...formData, gender: e.target.value})}><option value="">é¸æŠ...</option><option value="M">ç”·æ€§</option><option value="F">å¥³æ€§</option></select></div>
                                            <div><label class="label-text">ç”Ÿå¹´æœˆæ—¥</label><input type="date" class="form-input" value={formData.birth_date} onChange={e => setFormData({...formData, birth_date: e.target.value})} /></div>
                                        </div>
                                    )}

                                    {activeTab === 'docs' && (
                                        <div class="space-y-4 animate-in fade-in">
                                            {[
                                                { id: 'docs_land_titles', label: 'åœŸåœ°è¨¼æ˜æ›¸ (Land Titles)' },
                                                { id: 'docs_health_cert', label: 'å¥åº·è¨ºæ–­æ›¸ (Health Cert)' },
                                                { id: 'docs_criminal_record', label: 'ç„¡çŠ¯ç½ªè¨¼æ˜æ›¸ (Criminal Record)' }
                                            ].map(doc => (
                                                <label key={doc.id} class="flex items-center justify-between p-5 border-2 border-slate-50 rounded-2xl cursor-pointer hover:bg-slate-50 transition">
                                                    <span class="font-bold text-slate-700">{doc.label}</span>
                                                    <input type="checkbox" checked={formData[doc.id]} onChange={e => setFormData({...formData, [doc.id]: e.target.checked})} class="w-6 h-6 rounded border-slate-300 text-blue-600" />
                                                </label>
                                            ))}
                                        </div>
                                    )}

                                    {activeTab === 'interview' && (
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 animate-in fade-in">
                                            <div><label class="label-text">TOPIK ãƒ¬ãƒ™ãƒ«</label><select class="form-input" value={formData.topik_level} onChange={e => setFormData({...formData, topik_level: e.target.value})}><option value="">æœªå–å¾—</option><option value="1">1ç´š</option><option value="2">2ç´š</option></select></div>
                                            <div><label class="label-text">é¸æŠœç·åˆç‚¹ (0-100)</label><input type="number" class="form-input" value={formData.total_score} onChange={e => setFormData({...formData, total_score: parseInt(e.target.value) || 0})} /></div>
                                            <div class="md:col-span-2 text-xs text-slate-400 italic">â€»é¢æ¥è©³ç´°ã‚„å®ŸæŠ€è©•ä¾¡ã®é …ç›®ã‚‚ã“ã“ã«è¿½åŠ å¯èƒ½ã§ã™ã€‚</div>
                                        </div>
                                    )}

                                    {activeTab === 'dispatch' && (
                                        <div class="space-y-6 animate-in fade-in">
                                            <div><label class="label-text">æ´¾é£ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label><select class="form-input" value={formData.dispatch_status} onChange={e => setFormData({...formData, dispatch_status: e.target.value})}><option value="Waiting">å¾…æ©Ÿä¸­</option><option value="Dispatched">æ´¾é£æ¸ˆã¿</option><option value="Completed">æœŸé–“æº€äº†</option></select></div>
                                            <div><label class="label-text">ä¼æ¥­ã‹ã‚‰ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ / å‹¤å‹™æ…‹åº¦ãƒ¡ãƒ¢</label><textarea class="form-input h-32" value={formData.company_feedback} onChange={e => setFormData({...formData, company_feedback: e.target.value})} placeholder="å‹¤å‹™çŠ¶æ³ã‚„ãƒˆãƒ©ãƒ–ãƒ«ã€è©•ä¾¡ãªã©ã‚’å…¥åŠ›..." /></div>
                                        </div>
                                    )}

                                    <div class="mt-12 flex gap-4 border-t border-slate-50 pt-10">
                                        <button type="button" onClick={() => setView('list')} class="px-8 py-4 font-bold text-slate-400 hover:text-slate-600 transition">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                                        <button type="submit" disabled={loading} class="flex-grow py-4 bg-blue-600 text-white rounded-2xl font-black text-xs uppercase tracking-widest shadow-xl shadow-blue-500/30 hover:bg-blue-700 transition active:scale-95 disabled:opacity-50">
                                            {loading ? 'ä¿å­˜ä¸­...' : (formData.id ? 'å¤‰æ›´ã‚’ä¿å­˜ã™ã‚‹' : 'æ–°è¦ç™»éŒ²ã‚’å®Œäº†ã™ã‚‹')}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        function LoginForm({ supabase }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const handleLogin = async (e) => {
                e.preventDefault();
                const { error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: " + error.message);
            };
            return (
                <div class="min-h-screen flex items-center justify-center bg-slate-950 p-6">
                    <form onSubmit={handleLogin} class="bg-white p-12 rounded-[3rem] shadow-2xl w-full max-w-sm">
                        <h2 class="text-3xl font-black mb-10 text-center tracking-tighter text-slate-900">HSDEC LOGIN</h2>
                        <input type="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" class="form-input mb-4" onChange={e => setEmail(e.target.value)} required />
                        <input type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" class="form-input mb-8" onChange={e => setPassword(e.target.value)} required />
                        <button class="w-full bg-blue-600 text-white py-5 rounded-2xl font-black shadow-xl hover:bg-blue-700 transition">ãƒ­ã‚°ã‚¤ãƒ³</button>
                    </form>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
