<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HSDEC Worker Master Database</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; color: #0f172a; }
        .form-input, .form-select, .form-textarea { 
            border: 2px solid #e2e8f0; padding: 12px; border-radius: 12px; width: 100%; 
            font-weight: 700; background: white; outline: none; transition: border-color 0.2s;
        }
        .form-input:focus { border-color: #3b82f6; }
        .label-cap { font-size: 10px; font-weight: 900; color: #64748b; text-transform: uppercase; margin-bottom: 4px; display: block; }
        .section-header { font-size: 11px; font-weight: 900; color: #3b82f6; background: #eff6ff; padding: 8px 16px; border-radius: 8px; margin-top: 24px; margin-bottom: 12px; text-transform: uppercase; display: inline-block; }
        .progress-bg { width: 100%; height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden; margin-top: 8px; }
        .progress-fill { height: 100%; transition: width 0.3s ease; }
        .worker-card { border-width: 4px; border-color: transparent; transition: 0.3s; cursor: pointer; }
        .is-couple { border-color: #fbcfe8 !important; background-color: #fff1f2 !important; }
        .is-reentry { border-color: #bbf7d0 !important; background-color: #f0fdf4 !important; }
        .doc-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; border-radius: 12px; border: 2px solid #f1f5f9; cursor: pointer; font-size: 11px; font-weight: 700;}
        .doc-item.done { border-color: #10b981; background: #f0fdf4; color: #166534; }
        .doc-item.pending { border-color: #ef4444; background: #fef2f2; color: #991b1b; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const SUPABASE_URL = 'https://zgmqllufmqanixgwdjok.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_vOgl-K0RTxyK9i0WJp7UwA_PlwVgESz';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const DOC_LIST = [
            "Identity card", "Census", "Certificate of address", "Mobile phone", 
            "Land title", "Picture 3*4", "Picture 3,5*4,6", 
            "Agriculture certificate", "Health certificate", "Dollar bank account book", "Penalty notice"
        ];

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('folders'); 
            const [currentBatch, setCurrentBatch] = useState(1);
            const [workers, setWorkers] = useState([]);
            const [form, setForm] = useState({});
            const [searchTerm, setSearchTerm] = useState('');

            useEffect(() => {
                const savedUser = localStorage.getItem('hsdec_user');
                if (!savedUser) window.location.href = 'index.html';
                else { setUser(JSON.parse(savedUser)); fetchWorkers(); }
            }, []);

            const fetchWorkers = async () => {
                const { data } = await supabase.from('workers').select('*').order('name');
                if (data) setWorkers(data);
            };

            const calculateDocs = (w) => {
                const count = DOC_LIST.filter(doc => w[doc] === true).length;
                const percent = Math.round((count / DOC_LIST.length) * 100);
                return { count, percent };
            };

            const handlePhotoUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 300;
                        let width = img.width, height = img.height;
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        setForm({...form, photo_url: canvas.toDataURL('image/jpeg', 0.6)});
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            };

            const handleSave = async (e) => {
                e.preventDefault();
                const { error } = await supabase.from('workers').upsert([form]);
                if (!error) { setView('list'); fetchWorkers(); }
                else alert(error.message);
            };

            // Ê§úÁ¥¢„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
            const filteredWorkers = workers.filter(w => {
                const matchesBatch = w.batch == currentBatch;
                const searchStr = `${w.name} ${w.nickname} ${w.village} ${w.district} ${w.province}`.toLowerCase();
                const matchesSearch = searchStr.includes(searchTerm.toLowerCase());
                return matchesBatch && matchesSearch;
            });

            if (!user) return null;

            if (view === 'folders') return (
                <div className="max-w-4xl mx-auto p-8 text-center">
                    <h1 className="text-5xl font-black italic mb-12 tracking-tighter text-slate-800 uppercase">Batch Directory</h1>
                    <div className="grid grid-cols-1 gap-6">
                        {[1, 2, 3].map(num => (
                            <div key={num} onClick={() => { setCurrentBatch(num); setView('list'); }} 
                                 className="bg-white p-12 rounded-[3rem] border-2 border-slate-100 shadow-xl flex justify-between items-center cursor-pointer hover:scale-[1.02] transition-all group">
                                <div className="text-left">
                                    <span className="text-slate-400 font-black text-xs uppercase tracking-widest">Generation Group</span>
                                    <h2 className="text-4xl font-black italic text-slate-800 uppercase">Batch {num}</h2>
                                </div>
                                <div className="text-4xl group-hover:translate-x-2 transition-transform">üìÇ</div>
                            </div>
                        ))}
                    </div>
                </div>
            );

            if (view === 'list') return (
                <div className="max-w-4xl mx-auto p-4">
                    <header className="py-8 px-2">
                        <div className="flex justify-between items-end mb-6">
                            <div>
                                <button onClick={() => setView('folders')} className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">‚Üê Directory</button>
                                <h2 className="text-4xl font-black italic uppercase leading-none">Batch {currentBatch}</h2>
                            </div>
                            <button onClick={() => { setForm({batch: currentBatch, gender:'Male', diseases:'None', allergies:'None', tattoos:'None'}); setView('edit'); }} className="bg-black text-white px-8 py-4 rounded-2xl font-black text-xs shadow-lg">+ NEW WORKER</button>
                        </div>
                        
                        {/* SEARCH BAR */}
                        <div className="flex gap-2">
                            <input 
                                type="text" 
                                placeholder="Search by name, nickname, or address..." 
                                className="form-input flex-grow shadow-sm italic"
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                            />
                            <select 
                                className="form-select w-32 shadow-sm"
                                value={currentBatch}
                                onChange={(e) => setCurrentBatch(e.target.value)}
                            >
                                <option value="1">Batch 1</option>
                                <option value="2">Batch 2</option>
                                <option value="3">Batch 3</option>
                            </select>
                        </div>
                    </header>

                    <div className="grid gap-4">
                        {filteredWorkers.map(w => {
                            const { count, percent } = calculateDocs(w);
                            return (
                                <div key={w.id} onClick={() => { setForm(w); setView('edit'); }} 
                                     className={`worker-card bg-white p-6 rounded-[2.5rem] shadow-sm flex items-center gap-6 ${w.is_couple ? 'is-couple' : ''} ${w.is_reentry ? 'is-reentry' : ''}`}>
                                    <div className="w-20 h-20 bg-slate-200 rounded-[1.5rem] overflow-hidden flex-shrink-0 shadow-inner">
                                        {w.photo_url ? <img src={w.photo_url} className="w-full h-full object-cover" /> : <div className="flex items-center justify-center h-full text-[10px] font-black text-slate-400 uppercase">Photo</div>}
                                    </div>
                                    <div className="flex-grow">
                                        <div className="flex justify-between items-start">
                                            <div>
                                                <h3 className="font-black text-2xl uppercase tracking-tight">{w.name}</h3>
                                                <p className="text-[10px] font-bold text-slate-400 uppercase">{w.nickname || 'No Nickname'} ‚Ä¢ {w.province || 'Unknown Location'}</p>
                                            </div>
                                            <div className="text-right">
                                                <span className={`text-[10px] font-black px-2 py-1 rounded ${percent === 100 ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-100 text-slate-500'}`}>
                                                    DOCS: {count}/{DOC_LIST.length}
                                                </span>
                                            </div>
                                        </div>
                                        <div className="progress-bg">
                                            <div className={`progress-fill ${percent === 100 ? 'bg-emerald-500' : 'bg-blue-500'}`} style={{width: `${percent}%`}}></div>
                                        </div>
                                        <div className="flex gap-2 mt-3">
                                            {w.is_reentry && <span className="bg-emerald-500 text-white text-[8px] font-black px-2 py-0.5 rounded uppercase">Re-entry (B{w.prev_batch || '?'})</span>}
                                            {w.is_couple && <span className="bg-pink-500 text-white text-[8px] font-black px-2 py-0.5 rounded uppercase">Couple</span>}
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );

            return (
                <div className="max-w-4xl mx-auto p-4 pb-24">
                    <form onSubmit={handleSave} className="bg-white p-8 md:p-12 rounded-[3.5rem] shadow-2xl border relative">
                        <button type="button" onClick={() => setView('list')} className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-8">‚Üê Back to List</button>
                        
                        <div className="flex justify-between items-start mb-10">
                            <h2 className="text-3xl font-black italic uppercase leading-none">{form.name || 'New Profile'}</h2>
                            <div className="w-32 h-32 bg-slate-100 rounded-3xl border-4 border-white shadow-lg overflow-hidden flex-shrink-0 relative group">
                                {form.photo_url ? <img src={form.photo_url} className="w-full h-full object-cover" /> : <div className="flex items-center justify-center h-full text-[10px] font-black text-slate-400 uppercase">Photo</div>}
                                <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center cursor-pointer">
                                    <label htmlFor="photo-upload" className="text-white text-[10px] font-black uppercase cursor-pointer">Update Photo</label>
                                </div>
                                <input type="file" id="photo-upload" className="hidden" accept="image/*" onChange={handlePhotoUpload} />
                            </div>
                        </div>

                        <div className="section-header">1. Documents Status</div>
                        <div className="grid grid-cols-2 md:grid-cols-3 gap-2 mb-6">
                            {DOC_LIST.map(d => (
                                <div key={d} onClick={() => setForm({...form, [d]: !form[d]})} className={`doc-item ${form[d] ? 'done' : 'pending'}`}>
                                    <span>{d}</span>
                                    <span>{form[d] ? '‚úì' : '‚óã'}</span>
                                </div>
                            ))}
                        </div>

                        <div className="section-header">2. Basic Details</div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div><label className="label-cap">Assigned Batch</label><select className="form-select border-blue-200" value={form.batch || 1} onChange={e => setForm({...form, batch: parseInt(e.target.value)})}><option value="1">Batch 1</option><option value="2">Batch 2</option><option value="3">Batch 3</option></select></div>
                            <div><label className="label-cap">Gender</label><select className="form-select" value={form.gender} onChange={e => setForm({...form, gender: e.target.value})}><option value="Male">Male</option><option value="Female">Female</option></select></div>
                            <div><label className="label-cap">Full Name</label><input className="form-input" value={form.name || ''} onChange={e => setForm({...form, name: e.target.value})} required /></div>
                            <div><label className="label-cap">Nickname</label><input className="form-input" value={form.nickname || ''} onChange={e => setForm({...form, nickname: e.target.value})} /></div>
                            <div><label className="label-cap">Date of Birth</label><input type="date" className="form-input" value={form.birthday || ''} onChange={e => setForm({...form, birthday: e.target.value})} /></div>
                            <div><label className="label-cap">Age</label><input type="number" className="form-input" value={form.age || ''} onChange={e => setForm({...form, age: e.target.value})} /></div>
                        </div>

                        <div className="section-header">3. Address Information</div>
                        <div className="grid grid-cols-3 gap-4 mt-2">
                            <div><label className="label-cap">Village</label><input className="form-input" value={form.village || ''} onChange={e => setForm({...form, village: e.target.value})} /></div>
                            <div><label className="label-cap">District</label><input className="form-input" value={form.district || ''} onChange={e => setForm({...form, district: e.target.value})} /></div>
                            <div><label className="label-cap">Province</label><input className="form-input" value={form.province || ''} onChange={e => setForm({...form, province: e.target.value})} /></div>
                        </div>

                        <div className="section-header">4. Health Report</div>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div><label className="label-cap">Weight (kg)</label><input type="number" className="form-input" value={form.weight || ''} onChange={e => setForm({...form, weight: e.target.value})} /></div>
                            <div><label className="label-cap">Height (cm)</label><input type="number" className="form-input" value={form.height || ''} onChange={e => setForm({...form, height: e.target.value})} /></div>
                            <div><label className="label-cap">Arm Strength</label><select className="form-select" value={form.arm_strength || ''} onChange={e => setForm({...form, arm_strength: e.target.value})}><option value="">-</option><option value="Good">Good</option><option value="Problem">Problem</option></select></div>
                            <div><label className="label-cap">Eyesight</label><select className="form-select" value={form.eyesight || ''} onChange={e => setForm({...form, eyesight: e.target.value})}><option value="">-</option><option value="Good">Good</option><option value="Problem">Problem</option></select></div>
                        </div>

                        <div className="section-header">5. Status & History</div>
                        <div className="grid grid-cols-2 gap-4 mb-6">
                            <div onClick={() => setForm({...form, is_reentry: !form.is_reentry})} className={`doc-item ${form.is_reentry ? 'done border-emerald-500' : 'pending'}`}>
                                <span>RE-ENTRY (GREEN)</span>
                                <span>{form.is_reentry ? 'YES' : 'NO'}</span>
                            </div>
                            <div onClick={() => setForm({...form, is_couple: !form.is_couple})} className={`doc-item ${form.is_couple ? 'bg-pink-500 text-white border-pink-600' : 'pending'}`}>
                                <span>COUPLE (PINK)</span>
                                <span>{form.is_couple ? 'YES' : 'NO'}</span>
                            </div>
                        </div>

                        {/* RE-ENTRY DETAILS */}
                        {form.is_reentry && (
                            <div className="bg-emerald-50 p-6 rounded-[2rem] mb-6 border border-emerald-100">
                                <label className="label-cap text-emerald-600">Which previous batch did they join?</label>
                                <select className="form-select" value={form.prev_batch || ''} onChange={e => setForm({...form, prev_batch: e.target.value})}>
                                    <option value="">Select Previous Batch...</option>
                                    <option value="1">Batch 1</option>
                                    <option value="2">Batch 2</option>
                                </select>
                            </div>
                        )}

                        {/* COUPLE DETAILS */}
                        {form.is_couple && (
                            <div className="bg-pink-50 p-6 rounded-[2rem] mb-6 border border-pink-100">
                                <label className="label-cap text-pink-500">Partner Selection ({form.gender === 'Male' ? 'Female List' : 'Male List'})</label>
                                <select className="form-select" value={form.partner_id || ''} onChange={e => setForm({...form, partner_id: e.target.value})}>
                                    <option value="">Select Partner Name...</option>
                                    {workers.filter(w => w.gender !== form.gender).map(w => <option key={w.id} value={w.id}>{w.name}</option>)}
                                </select>
                            </div>
                        )}

                        <button type="submit" className="w-full bg-blue-600 text-white py-6 rounded-[2rem] font-black text-xl mt-10 shadow-2xl hover:bg-blue-700 active:scale-95 transition-all uppercase tracking-widest italic">Save Master Record</button>
                    </form>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
