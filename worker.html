<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HSDEC Worker Master Database</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; color: #0f172a; }
        .form-input, .form-select, .form-textarea { 
            border: 2px solid #e2e8f0; padding: 12px; border-radius: 12px; width: 100%; 
            font-weight: 700; background: white; outline: none; transition: border-color 0.2s;
        }
        .form-input:focus { border-color: #3b82f6; }
        .label-cap { font-size: 10px; font-weight: 900; color: #64748b; text-transform: uppercase; margin-bottom: 4px; display: block; }
        .section-header { font-size: 11px; font-weight: 900; color: #3b82f6; background: #eff6ff; padding: 8px 16px; border-radius: 8px; margin-top: 24px; margin-bottom: 12px; text-transform: uppercase; display: inline-block; }
        .worker-card { border-width: 4px; border-color: transparent; transition: 0.3s; }
        .is-couple { border-color: #fbcfe8 !important; background-color: #fff1f2 !important; }
        .is-reentry { border-color: #bbf7d0 !important; background-color: #f0fdf4 !important; }
        .doc-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; border-radius: 12px; border: 2px solid #f1f5f9; cursor: pointer; font-size: 11px; font-weight: 700;}
        .doc-item.done { border-color: #10b981; background: #f0fdf4; color: #166534; }
        .doc-item.pending { border-color: #ef4444; background: #fef2f2; color: #991b1b; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const SUPABASE_URL = 'https://zgmqllufmqanixgwdjok.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_vOgl-K0RTxyK9i0WJp7UwA_PlwVgESz';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const DOC_LIST = [
            "Identity card", "Census", "Certificate of address", "Mobile phone", 
            "Land title", "Picture 3*4", "Picture 3,5*4,6", 
            "Agriculture certificate", "Health certificate", "Dollar bank account book", "Penalty notice"
        ];

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('folders'); 
            const [currentBatch, setCurrentBatch] = useState(null);
            const [workers, setWorkers] = useState([]);
            const [form, setForm] = useState({});

            useEffect(() => {
                const savedUser = localStorage.getItem('hsdec_user');
                if (!savedUser) window.location.href = 'index.html';
                else { setUser(JSON.parse(savedUser)); fetchWorkers(); }
            }, []);

            const fetchWorkers = async () => {
                const { data } = await supabase.from('workers').select('*').order('name');
                if (data) setWorkers(data);
            };

            const handleSave = async (e) => {
                e.preventDefault();
                const { error } = await supabase.from('workers').upsert([form]);
                if (!error) { setView('list'); fetchWorkers(); }
                else alert(error.message);
            };

            if (!user) return null;

            // --- FOLDER VIEW ---
            if (view === 'folders') return (
                <div className="max-w-4xl mx-auto p-8 text-center">
                    <h1 className="text-5xl font-black italic mb-12 tracking-tighter text-slate-800">BATCH DIRECTORY</h1>
                    <div className="grid grid-cols-1 gap-6">
                        {[1, 2, 3].map(num => (
                            <div key={num} onClick={() => { setCurrentBatch(num); setView('list'); }} 
                                 className="bg-white p-12 rounded-[3rem] border-2 border-slate-100 shadow-xl flex justify-between items-center cursor-pointer hover:scale-[1.02] transition-all group">
                                <div className="text-left">
                                    <span className="text-slate-400 font-black text-xs uppercase tracking-widest">Generation Group</span>
                                    <h2 className="text-4xl font-black italic text-slate-800 uppercase">Batch {num}</h2>
                                </div>
                                <div className="text-4xl group-hover:translate-x-2 transition-transform">üìÇ</div>
                            </div>
                        ))}
                    </div>
                </div>
            );

            // --- LIST VIEW ---
            if (view === 'list') return (
                <div className="max-w-4xl mx-auto p-4">
                    <header className="flex justify-between items-end py-8 px-2">
                        <div>
                            <button onClick={() => setView('folders')} className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">‚Üê Directory</button>
                            <h2 className="text-4xl font-black italic uppercase">Batch {currentBatch}</h2>
                        </div>
                        <button onClick={() => { setForm({batch: currentBatch, status:'Active', gender:'Male'}); setView('edit'); }} className="bg-black text-white px-8 py-4 rounded-2xl font-black text-xs shadow-lg">+ NEW WORKER</button>
                    </header>
                    <div className="grid gap-4">
                        {workers.filter(w => w.batch == currentBatch).map(w => (
                            <div key={w.id} onClick={() => { setForm(w); setView('edit'); }} 
                                 className={`worker-card bg-white p-6 rounded-[2.5rem] shadow-sm flex items-center gap-6 ${w.is_couple ? 'is-couple' : ''} ${w.is_reentry ? 'is-reentry' : ''}`}>
                                <div className="w-20 h-20 bg-slate-200 rounded-[1.5rem] overflow-hidden flex-shrink-0 shadow-inner">
                                    {w.photo_url ? <img src={w.photo_url} className="w-full h-full object-cover" /> : <div className="flex items-center justify-center h-full text-[10px] font-black text-slate-400 uppercase">Photo</div>}
                                </div>
                                <div className="flex-grow">
                                    <div className="flex justify-between items-center">
                                        <h3 className="font-black text-2xl uppercase tracking-tight">{w.name}</h3>
                                        <div className="flex gap-2">
                                            {w.is_reentry && <span className="bg-emerald-500 text-white text-[9px] font-black px-3 py-1 rounded-full uppercase italic">Re-entry</span>}
                                            {w.is_couple && <span className="bg-pink-500 text-white text-[9px] font-black px-3 py-1 rounded-full uppercase italic">Couple</span>}
                                        </div>
                                    </div>
                                    <p className="text-sm font-bold text-slate-400 mt-1 uppercase">{w.nickname || 'No Nickname'} ‚Ä¢ {w.whatsapp || w.phone || 'No Contact'}</p>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );

            // --- EDIT VIEW ---
            return (
                <div className="max-w-4xl mx-auto p-4 pb-24">
                    <form onSubmit={handleSave} className="bg-white p-8 md:p-12 rounded-[3.5rem] shadow-2xl border relative">
                        <button type="button" onClick={() => setView('list')} className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-8">‚Üê Back to List</button>
                        
                        <div className="flex justify-between items-start mb-10">
                            <h2 className="text-3xl font-black italic uppercase leading-none">{form.name || 'New Profile'}</h2>
                            <div className="w-32 h-32 bg-slate-100 rounded-3xl border-4 border-white shadow-lg overflow-hidden flex-shrink-0 relative">
                                {form.photo_url ? <img src={form.photo_url} className="w-full h-full object-cover" /> : <div className="flex items-center justify-center h-full text-[10px] font-black text-slate-400 uppercase">Photo</div>}
                                <div className="absolute bottom-0 w-full bg-black/60 p-2 text-center">
                                    <input type="text" placeholder="Photo URL" className="w-full text-[8px] bg-white/20 text-white p-1 outline-none rounded" value={form.photo_url || ''} onChange={e => setForm({...form, photo_url: e.target.value})} />
                                </div>
                            </div>
                        </div>

                        <div className="section-header">1. Documents Status</div>
                        <div className="grid grid-cols-2 md:grid-cols-3 gap-2 mb-6">
                            {DOC_LIST.map(d => (
                                <div key={d} onClick={() => setForm({...form, [d]: !form[d]})} className={`doc-item ${form[d] ? 'done' : 'pending'}`}>
                                    <span>{d}</span>
                                </div>
                            ))}
                        </div>

                        <div className="section-header">2. Basic Details</div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            {/* HERE IS THE BATCH SELECTION! */}
                            <div><label className="label-cap">Assigned Batch</label><select className="form-select border-blue-200" value={form.batch || 1} onChange={e => setForm({...form, batch: parseInt(e.target.value)})}><option value="1">Batch 1</option><option value="2">Batch 2</option><option value="3">Batch 3</option></select></div>
                            <div><label className="label-cap">Gender</label><select className="form-select" value={form.gender} onChange={e => setForm({...form, gender: e.target.value})}><option value="Male">Male</option><option value="Female">Female</option></select></div>
                            <div><label className="label-cap">First & Last Name</label><input className="form-input" value={form.name || ''} onChange={e => setForm({...form, name: e.target.value})} required /></div>
                            <div><label className="label-cap">Nickname</label><input className="form-input" value={form.nickname || ''} onChange={e => setForm({...form, nickname: e.target.value})} /></div>
                            <div><label className="label-cap">Date of Birth</label><input type="date" className="form-input" value={form.birthday || ''} onChange={e => setForm({...form, birthday: e.target.value})} /></div>
                            <div><label className="label-cap">Age</label><input type="number" className="form-input" value={form.age || ''} onChange={e => setForm({...form, age: e.target.value})} /></div>
                            <div><label className="label-cap">Place of Birth</label><input className="form-input" value={form.birth_place || ''} onChange={e => setForm({...form, birth_place: e.target.value})} /></div>
                        </div>
                        <div className="mt-4"><label className="label-cap">Current Address</label><input className="form-input" value={form.current_address || ''} onChange={e => setForm({...form, current_address: e.target.value})} /></div>
                        <div className="grid grid-cols-3 gap-4 mt-4">
                            <div><label className="label-cap">Village</label><input className="form-input" value={form.village || ''} onChange={e => setForm({...form, village: e.target.value})} /></div>
                            <div><label className="label-cap">District</label><input className="form-input" value={form.district || ''} onChange={e => setForm({...form, district: e.target.value})} /></div>
                            <div><label className="label-cap">Province</label><input className="form-input" value={form.province || ''} onChange={e => setForm({...form, province: e.target.value})} /></div>
                        </div>

                        <div className="section-header">3. Education & Background</div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label className="label-cap">Education Foreign Language</label><input className="form-input" value={form.education_lang || ''} onChange={e => setForm({...form, education_lang: e.target.value})} /></div>
                            <div><label className="label-cap">Occupation</label><input className="form-input" value={form.occupation || ''} onChange={e => setForm({...form, occupation: e.target.value})} /></div>
                            <div><label className="label-cap">Lives with</label><input className="form-input" value={form.lives_with || ''} onChange={e => setForm({...form, lives_with: e.target.value})} /></div>
                            <div><label className="label-cap">Children</label><input className="form-input" value={form.children || ''} onChange={e => setForm({...form, children: e.target.value})} /></div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <div><label className="label-cap">Worked abroad?</label><input className="form-input" value={form.work_abroad || ''} onChange={e => setForm({...form, work_abroad: e.target.value})} /></div>
                            <div><label className="label-cap">Work Experience</label><textarea className="form-textarea" value={form.work_exp || ''} onChange={e => setForm({...form, work_exp: e.target.value})}></textarea></div>
                        </div>

                        <div className="section-header">4. Physical & Health Report</div>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div><label className="label-cap">Weight (kg)</label><input type="number" className="form-input" value={form.weight || ''} onChange={e => setForm({...form, weight: e.target.value})} /></div>
                            <div><label className="label-cap">Height (cm)</label><input type="number" className="form-input" value={form.height || ''} onChange={e => setForm({...form, height: e.target.value})} /></div>
                            <div><label className="label-cap">Arm Strength</label><select className="form-select" value={form.arm_strength || ''} onChange={e => setForm({...form, arm_strength: e.target.value})}><option value="">-</option><option value="Good">Good</option><option value="Problem">Problem</option></select></div>
                            <div><label className="label-cap">Eyesight</label><select className="form-select" value={form.eyesight || ''} onChange={e => setForm({...form, eyesight: e.target.value})}><option value="">-</option><option value="Good">Good</option><option value="Problem">Problem</option></select></div>
                            <div className="col-span-2"><label className="label-cap">Identified Diseases</label><select className="form-select" value={form.diseases || ''} onChange={e => setForm({...form, diseases: e.target.value})}><option value="None">None</option><option value="Have">Have</option></select></div>
                            <div className="col-span-2"><label className="label-cap">Allergies</label><select className="form-select" value={form.allergies || ''} onChange={e => setForm({...form, allergies: e.target.value})}><option value="None">None</option><option value="Have">Have</option></select></div>
                            <div className="col-span-4"><label className="label-cap">Tattoos</label><select className="form-select" value={form.tattoos || ''} onChange={e => setForm({...form, tattoos: e.target.value})}><option value="None">None</option><option value="Have">Have</option></select></div>
                        </div>

                        <div className="section-header">5. Contact & Registry</div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div><label className="label-cap">WhatsApp</label><input className="form-input" value={form.whatsapp || ''} onChange={e => setForm({...form, whatsapp: e.target.value})} /></div>
                            <div><label className="label-cap">Contact Number</label><input className="form-input" value={form.phone || ''} onChange={e => setForm({...form, phone: e.target.value})} /></div>
                            <div><label className="label-cap">Passport Number</label><input className="form-input" value={form.passport_no || ''} onChange={e => setForm({...form, passport_no: e.target.value})} /></div>
                            <div className="col-span-2"><label className="label-cap">Guarantor</label><input className="form-input" value={form.guarantor || ''} onChange={e => setForm({...form, guarantor: e.target.value})} /></div>
                            <div><label className="label-cap">Census Dependent</label><input className="form-input" value={form.census_dependent || ''} onChange={e => setForm({...form, census_dependent: e.target.value})} /></div>
                        </div>

                        <div className="section-header">6. Final Status & Couple Linking</div>
                        <div className="grid grid-cols-2 gap-4 mb-6">
                            <div onClick={() => setForm({...form, is_reentry: !form.is_reentry})} className={`doc-item ${form.is_reentry ? 'done' : 'pending'}`}>
                                <span>RE-ENTRY (GREEN)</span>
                            </div>
                            <div onClick={() => setForm({...form, is_couple: !form.is_couple})} className={`doc-item ${form.is_couple ? 'bg-pink-500 text-white border-pink-600' : 'pending'}`}>
                                <span>COUPLE (PINK)</span>
                            </div>
                        </div>

                        {form.is_couple && (
                            <div className="bg-pink-50 p-6 rounded-[2rem] mb-10 border border-pink-100">
                                <label className="label-cap text-pink-500">Partner Selection ({form.gender === 'Male' ? 'Female List' : 'Male List'})</label>
                                <select className="form-select" value={form.partner_id || ''} onChange={e => setForm({...form, partner_id: e.target.value})}>
                                    <option value="">Select Partner Name...</option>
                                    {workers.filter(w => w.gender !== form.gender).map(w => <option key={w.id} value={w.id}>{w.name}</option>)}
                                </select>
                            </div>
                        )}

                        <button type="submit" className="w-full bg-blue-600 text-white py-6 rounded-[2rem] font-black text-xl mt-10 shadow-2xl hover:bg-blue-700 active:scale-95 transition-all uppercase tracking-widest italic">Save Master Record</button>
                    </form>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
