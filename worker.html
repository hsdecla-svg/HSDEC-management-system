<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HSDEC Worker | Full Secure</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; color: #1e293b; }
        .form-input, .form-select, .form-textarea { border: 2px solid #e2e8f0; padding: 10px; border-radius: 10px; width: 100%; font-weight: 700; background: white; outline: none; }
        .label-cap { font-size: 10px; font-weight: 900; color: #94a3b8; text-transform: uppercase; margin-bottom: 2px; display: block; }
        .section-title { font-size: 11px; font-weight: 900; color: #1e293b; background: #e2e8f0; padding: 8px 12px; border-radius: 8px; margin: 20px 0 10px 0; text-transform: uppercase; border-left: 5px solid #10b981; }
        .modal-full { position: fixed; inset: 0; background: #f8fafc; z-index: 1000; overflow-y: auto; padding: 20px; }
        .doc-chip { font-size: 8px; font-weight: 900; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; border: 1px solid currentColor; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const SUPABASE_URL = 'https://zgmqllufmqanixgwdjok.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_vOgl-K0RTxyK9i0WJp7UwA_PlwVgESz';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const USERS = [
            { id: "Takashi", pw: "Tks83446423", name: "Mr. Takashi", role: "admin" },
            { id: "Chansouk", pw: "97372185", name: "Ms. Chansouk", role: "staff" },
            { id: "Mim", pw: "78277996", name: "Ms. Mim", role: "staff" },
            { id: "Chanthaviphone", pw: "96086112", name: "Mr. Chanthaviphone", role: "vv" },
            { id: "Sengmala", pw: "22886998", name: "Ms. Sengmala", role: "sv" },
            { id: "Guest", pw: "HSDEC2025", name: "Guest User", role: "guest" }
        ];

        const DOC_LABELS = {
            id_card: "ID Card", census: "Census", cert_address: "Cert Address",
            mobile_phone: "Mobile", land_title: "Land Title", pic_3x4: "Pic 3*4",
            pic_35x46: "Pic 3.5*4.6", penalty_notice: "Penalty", agri_cert: "Agri Cert",
            health_cert: "Health Cert", dollar_book: "Dollar Book"
        };

        function WorkerApp() {
            const [user, setUser] = useState(null);
            // ページを開いた瞬間に index でのログイン情報をチェック
useEffect(() => {
    const savedUser = localStorage.getItem('hsdec_user');
    if (savedUser) {
        const found = JSON.parse(savedUser);
        setUser(found);
        // worker管理なら初期フォームに名前を入れるなどの処理
        if (typeof setWForm === 'function') setWForm(prev => ({...prev, guarantor: found.name}));
        if (typeof setFForm === 'function') setFForm(prev => ({...prev, staff_name: found.name}));
    }
}, []);

// ログアウト処理（indexに戻る）
const handleLogout = () => {
    localStorage.removeItem('hsdec_user');
    window.location.href = 'index.html';
};
            const [loginForm, setLoginForm] = useState({ id: '', pw: '' });
            const [workers, setWorkers] = useState([]);
            const [view, setView] = useState('list');
            const [selectedBatch, setSelectedBatch] = useState("all");

            const initialForm = {
                gender: 'Male', name: '', birthday: '', age: '',
                place_of_birth: '', current_address: '', village: '', district: '', province: '',
                education: '', foreign_language: '', occupation: '', lives_with: '', children: '',
                worked_abroad: '', work_experience: '', guarantor: '', id_number: '', 
                passport_number: '', diseases: '', allergies: '', weight: '', height: '',
                whatsapp: '', contact_number: '', arm_strength: '', eyesight: '', tattoos: '',
                photo_url: '', batch_no: 1, note: '',
                is_couple: false, is_reentry: false,
                id_card: false, census: false, cert_address: false, mobile_phone: false,
                land_title: false, pic_3x4: false, pic_35x46: false,
                penalty_notice: false, agri_cert: false, health_cert: false, dollar_book: false
            };
            const [wForm, setWForm] = useState(initialForm);

            const handleLogin = (e) => {
                e.preventDefault();
                const found = USERS.find(u => u.id === loginForm.id && u.pw === loginForm.pw);
                if (found) setUser(found); else alert("Invalid ID/PW");
            };

            const fetchWorkers = async () => {
                const { data } = await supabase.from('workers').select('*').order('name');
                if (data) setWorkers(data);
            };

            useEffect(() => { if(user) fetchWorkers(); }, [user]);

            const canRegister = user?.role === 'admin';
            const canEdit = ['admin', 'staff'].includes(user?.role);
            const canDelete = user?.role === 'admin';

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!canEdit) return;
                const payload = { ...wForm };
                ['age', 'weight', 'height', 'batch_no'].forEach(f => {
                    payload[f] = payload[f] ? parseInt(payload[f]) : null;
                });
                const { error } = await supabase.from('workers').upsert([payload]);
                if (!error) { alert("Saved!"); setView('list'); fetchWorkers(); }
            };

            if (!user) return (
                <div className="flex items-center justify-center min-h-screen p-6 bg-slate-900 text-white">
                    <form onSubmit={handleLogin} className="w-full max-w-sm space-y-6">
                        <h1 className="text-4xl font-black italic tracking-tighter text-center">HSDEC WORKER</h1>
                        <input type="text" placeholder="ID" className="form-input text-slate-900" onChange={e => setLoginForm({...loginForm, id: e.target.value})} />
                        <input type="password" placeholder="Password" className="form-input text-center text-slate-900 tracking-widest" onChange={e => setLoginForm({...loginForm, pw: e.target.value})} />
                        <button className="w-full bg-emerald-500 py-4 rounded-2xl font-black uppercase shadow-lg">Login</button>
                    </form>
                </div>
            );

            return (
                <div className="max-w-4xl mx-auto p-4 pb-20">
                    <header className="flex justify-between items-center py-6 border-b mb-6">
                        <div>
                            <h1 className="text-2xl font-black italic tracking-tighter">WORKER MASTER</h1>
                            <p className="text-[10px] font-black text-blue-500 uppercase">{user.name} ({user.role})</p>
                        </div>
                        {canRegister && <button onClick={() => { setWForm(initialForm); setView('edit'); }} className="bg-black text-white px-6 py-2 rounded-xl font-black text-xs">+ REGISTER</button>}
                    </header>

                    <div className="flex gap-2 mb-6 overflow-x-auto pb-2">
                        {["all", 1, 2, 3].map(bn => (
                            <button key={bn} onClick={() => setSelectedBatch(bn)} className={`px-4 py-2 rounded-full font-black text-xs uppercase ${selectedBatch === bn ? 'bg-slate-800 text-white' : 'bg-white border text-slate-400'}`}>
                                {bn === "all" ? "All" : `Batch ${bn}`}
                            </button>
                        ))}
                    </div>

                    <div className="space-y-4">
                        {workers.filter(w => selectedBatch === "all" ? true : w.batch_no == selectedBatch).map(w => (
                            <div key={w.id} onClick={() => { setWForm(w); setView('edit'); }} className={`p-4 rounded-[1.5rem] flex items-center justify-between border cursor-pointer bg-white shadow-sm hover:shadow-md transition-all`}>
                                <div className="flex items-center gap-4">
                                    <div className="w-12 h-12 bg-slate-100 rounded-xl overflow-hidden border">
                                        {w.photo_url && <img src={w.photo_url} className="w-full h-full object-cover" />}
                                    </div>
                                    <div>
                                        <p className="font-black text-slate-800">{w.name}</p>
                                        <p className="text-[9px] text-slate-400 font-bold uppercase">{w.village}, {w.district} · Batch {w.batch_no}</p>
                                    </div>
                                </div>
                                <div className="text-right">
                                    <p className="font-black text-sm">{w.age || '?'} yrs</p>
                                    <div className="flex gap-1 justify-end mt-1">
                                        {Object.keys(DOC_LABELS).slice(0, 5).map(key => (
                                            <div key={key} className={`w-2 h-2 rounded-full ${w[key] ? 'bg-emerald-400' : 'bg-slate-200'}`}></div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>

                    {view === 'edit' && (
                        <div className="modal-full">
                            <div className="max-w-2xl mx-auto pb-20">
                                <div className="flex justify-between items-center mb-6">
                                    <button onClick={() => setView('list')} className="font-black text-xs uppercase text-slate-400">Cancel</button>
                                    <p className="font-black italic">PROFILE</p>
                                </div>
                                <form onSubmit={handleSubmit} className="space-y-6">
                                    <div className="section-title">Status</div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <label className="flex items-center gap-2 p-3 bg-white rounded-xl border-2"><input type="checkbox" disabled={!canEdit} checked={wForm.is_couple} onChange={e => setWForm({...wForm, is_couple: e.target.checked})} /> <span className="text-xs font-black">COUPLE</span></label>
                                        <label className="flex items-center gap-2 p-3 bg-white rounded-xl border-2"><input type="checkbox" disabled={!canEdit} checked={wForm.is_reentry} onChange={e => setWForm({...wForm, is_reentry: e.target.checked})} /> <span className="text-xs font-black">RE-ENTRY</span></label>
                                    </div>

                                    <div className="section-title">Personal Info</div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="col-span-2"><label className="label-cap">Name</label><input type="text" className="form-input" readOnly={!canEdit} value={wForm.name} onChange={e => setWForm({...wForm, name: e.target.value})} required /></div>
                                        <div><label className="label-cap">Batch #</label><input type="number" className="form-input" readOnly={!canEdit} value={wForm.batch_no} onChange={e => setWForm({...wForm, batch_no: e.target.value})} /></div>
                                        <div><label className="label-cap">Birthday</label><input type="date" className="form-input" readOnly={!canEdit} value={wForm.birthday} onChange={e => setWForm({...wForm, birthday: e.target.value})} /></div>
                                        <div><label className="label-cap">Age</label><input type="number" className="form-input" readOnly={!canEdit} value={wForm.age} onChange={e => setWForm({...wForm, age: e.target.value})} /></div>
                                        <div><label className="label-cap">Gender</label><select className="form-select" disabled={!canEdit} value={wForm.gender} onChange={e => setWForm({...wForm, gender: e.target.value})}><option>Male</option><option>Female</option></select></div>
                                    </div>

                                    <div className="section-title">Address</div>
                                    <div className="grid grid-cols-3 gap-2">
                                        <div><label className="label-cap">Village</label><input type="text" className="form-input text-xs" readOnly={!canEdit} value={wForm.village} onChange={e => setWForm({...wForm, village: e.target.value})} /></div>
                                        <div><label className="label-cap">District</label><input type="text" className="form-input text-xs" readOnly={!canEdit} value={wForm.district} onChange={e => setWForm({...wForm, district: e.target.value})} /></div>
                                        <div><label className="label-cap">Province</label><input type="text" className="form-input text-xs" readOnly={!canEdit} value={wForm.province} onChange={e => setWForm({...wForm, province: e.target.value})} /></div>
                                    </div>

                                    <div className="section-title">Experience & Education</div>
                                    <div className="space-y-4">
                                        <div><label className="label-cap">Education</label><input type="text" className="form-input" readOnly={!canEdit} value={wForm.education} onChange={e => setWForm({...wForm, education: e.target.value})} /></div>
                                        <div><label className="label-cap">Work Experience</label><textarea className="form-textarea text-xs" readOnly={!canEdit} value={wForm.work_experience} onChange={e => setWForm({...wForm, work_experience: e.target.value})}></textarea></div>
                                    </div>

                                    <div className="section-title">Physical & Health</div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="label-cap">Height (cm)</label><input type="number" className="form-input" readOnly={!canEdit} value={wForm.height} onChange={e => setWForm({...wForm, height: e.target.value})} /></div>
                                        <div><label className="label-cap">Weight (kg)</label><input type="number" className="form-input" readOnly={!canEdit} value={wForm.weight} onChange={e => setWForm({...wForm, weight: e.target.value})} /></div>
                                        <div className="col-span-2"><label className="label-cap">Tattoos</label><input type="text" className="form-input" readOnly={!canEdit} value={wForm.tattoos} onChange={e => setWForm({...wForm, tattoos: e.target.value})} /></div>
                                    </div>

                                    <div className="section-title">Documents Check</div>
                                    <div className="grid grid-cols-2 gap-2">
                                        {Object.keys(DOC_LABELS).map(key => (
                                            <label key={key} className={`flex items-center justify-between p-2 rounded-lg border ${wForm[key] ? 'border-emerald-500 bg-emerald-50' : 'border-slate-100'}`}>
                                                <span className="text-[10px] font-bold uppercase">{DOC_LABELS[key]}</span>
                                                <input type="checkbox" disabled={!canEdit} checked={wForm[key]} onChange={e => setWForm({...wForm, [key]: e.target.checked})} />
                                            </label>
                                        ))}
                                    </div>

                                    {canEdit && <button type="submit" className="w-full bg-emerald-600 text-white py-5 rounded-2xl font-black shadow-xl uppercase">Save Changes</button>}
                                    {canDelete && wForm.id && (
                                        <button type="button" onClick={async () => { if(confirm("Delete?")) { await supabase.from('workers').delete().eq('id', wForm.id); setView('list'); fetchWorkers(); }}} className="w-full bg-rose-50 text-rose-500 py-3 rounded-2xl font-black text-xs mt-2 uppercase">Delete Worker</button>
                                    )}
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<WorkerApp />);
    </script>
</body>
</html>
